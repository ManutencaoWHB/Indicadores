<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Análise de Manutenção</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    typography: (theme) => ({
                        DEFAULT: {
                            css: {
                                'h4': {
                                    color: theme('colors.gray.800'),
                                    fontWeight: '600',
                                    marginBottom: theme('spacing.2'),
                                },
                                'ol > li::before': {
                                    color: theme('colors.gray.500'),
                                },
                                'ol > li': {
                                    marginTop: theme('spacing.2'),
                                    paddingTop: theme('spacing.2'),
                                }
                            },
                        },
                        invert: {
                            css: {
                                'h4': {
                                    color: theme('colors.gray.200'),
                                },
                                'ol > li::before': {
                                    color: theme('colors.gray.400'),
                                },
                            },
                        }
                    })
                }
            }
        }

        // Script para aplicar o tema na carga inicial
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .file-input-button { background-color: #4f46e5; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: background-color: 0.3s; width: 100%; }
        .file-input-button:hover { background-color: #4338ca; }
        input[type="file"] { display: none; }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background-color: #eef2ff; }
        .dark th.sortable:hover { background-color: #312e81; }
        .details-row { display: none; }
        .toggle-details { cursor: pointer; font-weight: bold; font-size: 1.25rem; width: 24px; text-align: center; }
        .draggable-row { cursor: grab; }
        .draggable-row:active { cursor: grabbing; }
        .drop-target-highlight {
            outline: 2px dashed #4f46e5;
            outline-offset: -4px;
            background-color: rgba(79, 70, 229, 0.1);
        }
        /* Estilos para o Chatbot */
        .chat-message {
            max-width: 80%;
        }
        .user-message {
            align-self: flex-end;
            background-color: #4f46e5;
            color: white;
        }
        .bot-message {
            align-self: flex-start;
            background-color: #e5e7eb;
        }
        .dark .bot-message {
            background-color: #374151;
        }
        .nav-active {
            background-color: #eef2ff; /* bg-indigo-100 */
            color: #312e81;
            font-weight: 600;
        }
        .dark .nav-active {
            background-color: #3730a3; /* dark:bg-indigo-800 */
            color: white;
        }
        .control-btn-active {
            background-color: #4f46e5 !important;
            color: white !important;
        }
        .dark .control-btn-active {
             background-color: #3730a3 !important;
        }
        .order-title-toggle {
            cursor: pointer;
            text-decoration: none; /* Sublinhado removido */
            color: #4f46e5; /* indigo-600 */
        }
        .order-title-toggle:hover {
            text-decoration: underline; /* Sublinhado adicionado no hover */
        }
        .dark .order-title-toggle {
            color: #818cf8; /* indigo-400 */
        }
        .solution-details {
            display: none;
            padding: 8px;
            margin-top: 4px;
            background-color: #f3f4f6; /* gray-100 */
            border-radius: 4px;
        }
        .dark .solution-details {
             background-color: #4b5563; /* gray-600 */
        }
    </style>
</head>
<body class="antialiased bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

<div class="flex h-screen bg-gray-100 dark:bg-gray-900">
    <div id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-white dark:bg-gray-800 shadow-md flex-shrink-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-40 flex flex-col">
        <div>
            <div class="p-4 border-b dark:border-gray-700">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">Menu Principal</h2>
            </div>
            
            <div class="p-4 border-b dark:border-gray-700">
                 <label for="file-upload" class="file-input-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    <span>Carregar Planilha</span>
                </label>
                <input id="file-upload" type="file" accept=".xlsx, .xls, .csv">
                <p id="file-name" class="mt-2 text-xs text-center text-gray-500 dark:text-gray-400 truncate">Nenhum arquivo.</p>
            </div>

            <nav class="mt-4">
                <a href="#" id="nav-analyzer" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 nav-active">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    Analisador de Indicadores
                </a>
                <a href="#" id="nav-dashboard" class="flex items-center px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    Dashboard
                </a>
                <a href="#" id="nav-chatbot" class="flex items-center px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                    Chatbot da Manutenção
                </a>
            </nav>
        </div>
        <div class="mt-auto p-4 border-t dark:border-gray-700">
            <button id="theme-toggle" type="button" class="w-full flex items-center justify-center text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
                <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                <span class="ml-2">Alternar Tema</span>
            </button>
        </div>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <main class="flex-1 overflow-y-auto">
        <div id="dashboard-page" class="page-content hidden">
             <div class="container mx-auto p-4 sm:p-6 lg:p-8 space-y-8">
                <header class="text-center relative">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white">Dashboard de Manutenção</h1>
                </header>
                
                <div id="dashboard-filters-section" class="hidden max-w-7xl mx-auto bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-4">
                        <div>
                            <label for="dashboard-report-start-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Data Inicial</label>
                            <input type="date" id="dashboard-report-start-date" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="dashboard-report-end-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Data Final</label>
                            <input type="date" id="dashboard-report-end-date" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm">
                        </div>
                        <div class="md:col-span-2">
                             <label class="block text-sm font-medium text-transparent">&nbsp;</label>
                            <button id="dashboard-update-charts" class="mt-1 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-sm">Atualizar Gráficos do Dashboard</button>
                        </div>
                    </div>
                </div>

                <div id="kpi-trend-section" class="hidden">
                     <h2 class="text-xl font-bold text-center text-gray-800 dark:text-gray-200 mb-4">Análise de Tendência de KPIs</h2>
                     <div class="flex justify-center flex-wrap gap-2 mb-4">
                        <div id="kpi-trend-kpi-controls" class="flex justify-center p-1 bg-gray-200 dark:bg-gray-700 rounded-lg">
                            <button data-kpi="availability" class="kpi-trend-kpi-btn control-btn-active px-4 py-1 text-sm font-semibold rounded-md">Disponibilidade</button>
                            <button data-kpi="mttr" class="kpi-trend-kpi-btn px-4 py-1 text-sm font-semibold rounded-md">MTTR</button>
                            <button data-kpi="mtbf" class="kpi-trend-kpi-btn px-4 py-1 text-sm font-semibold rounded-md">MTBF</button>
                        </div>
                        <div id="kpi-trend-period-controls" class="flex justify-center p-1 bg-gray-200 dark:bg-gray-700 rounded-lg">
                            <button data-period="monthly" class="kpi-trend-period-btn control-btn-active px-4 py-1 text-sm font-semibold rounded-md">Mensal</button>
                            <button data-period="weekly" class="kpi-trend-period-btn px-4 py-1 text-sm font-semibold rounded-md">Semanal</button>
                        </div>
                     </div>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 max-w-2xl mx-auto">
                        <div>
                            <label for="kpi-trend-availability-goal" class="block text-xs font-medium text-gray-700 dark:text-gray-300">Meta Disp. (>=)</label>
                            <input type="number" id="kpi-trend-availability-goal" class="kpi-trend-goal-input mt-1 block w-full p-1 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm text-sm" value="97">
                        </div>
                        <div>
                            <label for="kpi-trend-mttr-goal" class="block text-xs font-medium text-gray-700 dark:text-gray-300">Meta MTTR (<=)</label>
                            <input type="number" id="kpi-trend-mttr-goal" class="kpi-trend-goal-input mt-1 block w-full p-1 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm text-sm" value="2">
                        </div>
                        <div>
                            <label for="kpi-trend-mtbf-goal" class="block text-xs font-medium text-gray-700 dark:text-gray-300">Meta MTBF (>=)</label>
                            <input type="number" id="kpi-trend-mtbf-goal" class="kpi-trend-goal-input mt-1 block w-full p-1 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm text-sm" value="90">
                        </div>
                    </div>
                     <div id="kpi-trend-container" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                        <canvas id="kpi-trend-canvas"></canvas>
                    </div>
                </div>

                <div id="dashboard-pareto-machine-section" class="hidden">
                    <div class="flex justify-center items-center mb-4 relative">
                        <h2 class="text-xl font-bold text-center text-gray-800 dark:text-gray-200">Pareto de Horas Paradas por Máquina</h2>
                        <button id="print-machine-pareto-button" class="absolute right-0 p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg" title="Imprimir Gráfico">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm3 0h4v3H8V4zm6 8H6v4h8v-4z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <div id="dashboard-controls" class="max-w-xl mx-auto mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow">
                        <label for="dashboard-pareto-slider" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Quantidade de Máquinas a Exibir: <span id="dashboard-pareto-slider-value" class="font-bold text-indigo-600 dark:text-indigo-400">10</span></label>
                        <input id="dashboard-pareto-slider" type="range" min="1" max="50" value="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                    </div>
                    <div id="dashboard-pareto-container" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                        <canvas id="dashboard-pareto-canvas"></canvas>
                    </div>
                </div>

                <div id="dashboard-pareto-daily-section" class="hidden">
                     <div class="flex justify-center items-center mb-4 relative">
                        <h2 class="text-xl font-bold text-center text-gray-800 dark:text-gray-200">Pareto Diário de Paradas e Ordens</h2>
                        <button id="print-daily-pareto-button" class="absolute right-0 p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg" title="Imprimir Gráfico">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm3 0h4v3H8V4zm6 8H6v4h8v-4z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                     <div id="dashboard-daily-pareto-container" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                        <canvas id="dashboard-daily-pareto-canvas"></canvas>
                    </div>
                </div>

                <div id="dashboard-no-data" class="text-center mt-8 p-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
                    <p class="text-gray-500 dark:text-gray-400">Por favor, carregue uma planilha e execute a análise na aba "Analisador de Indicadores" para visualizar o dashboard.</p>
                </div>
            </div>
        </div>

        <div id="analyzer-page" class="page-content">
            <header class="p-4 border-b dark:border-gray-700 md:hidden">
                <button id="menu-toggle-btn" class="text-gray-500 dark:text-gray-400 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
            </header>
            <div class="container mx-auto p-4 sm:p-6 lg:p-8">
                <header class="text-center mb-8 relative">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white">Analisador de Indicadores de Manutenção</h1>
                    <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">Calcule Disponibilidade, MTBF e MTTR a partir da sua planilha de paradas.</p>
                </header>
                
                 <div id="analyzer-no-data" class="text-center mt-8 p-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
                    <p class="text-gray-500 dark:text-gray-400">Por favor, carregue uma planilha no menu lateral para começar.</p>
                </div>

                <div id="analysis-section" class="hidden mt-8 max-w-7xl mx-auto bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Configurações da Análise</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-4">
                        <div>
                            <label for="report-start-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Data Inicial do Relatório</label>
                            <input type="date" id="report-start-date" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="report-end-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Data Final do Relatório</label>
                            <input type="date" id="report-end-date" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="year-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Ano</label>
                            <select id="year-select" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm"></select>
                        </div>
                        <div>
                            <label for="month-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mês</label>
                            <select id="month-select" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm"></select>
                        </div>
                        <div class="lg:col-span-2">
                            <label for="week-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Semana</label>
                            <select id="week-select" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm"></select>
                        </div>
                        <div class="lg:col-span-2">
                            <label for="production-line-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Filtrar por Linha de Produção</label>
                            <select id="production-line-filter" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm"></select>
                        </div>
                        <div>
                            <label for="total-hours" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Total de Horas no Período</label>
                            <input type="number" id="total-hours" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-200 rounded-md shadow-sm" readonly placeholder="Calculado automaticamente">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-transparent">&nbsp;</label>
                            <button id="clear-filters-button" class="mt-1 w-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 font-bold py-2 px-4 rounded-md shadow-sm">Limpar Filtros</button>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mb-6 mt-8 border-t border-gray-200 dark:border-gray-700 pt-8">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">Mapeamento de Colunas e Metas</h3>
                        <button id="toggle-report-fields" class="text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-300 text-3xl leading-none font-bold">
                            +
                        </button>
                    </div>
                    <div id="report-fields-content" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div>
                                <label for="machine-column" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Coluna de Ativos/Máquinas</label>
                                <select id="machine-column" class="config-select mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="asset-name-column" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Coluna Nome do Bem</label>
                                <select id="asset-name-column" class="config-select mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="downtime-column" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Coluna de Duração (horas)</label>
                                <select id="downtime-column" class="config-select mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="cost-center-column" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Coluna Linha de Produção</label>
                                <select id="cost-center-column" class="config-select mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="service-order-column" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Coluna Ordem de Serviço</label>
                                <select id="service-order-column" class="config-select mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="order-title-column" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Coluna Título da Ordem</label>
                                <select id="order-title-column" class="config-select mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="solution-details-column" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Coluna Detalhes da Solução</label>
                                <select id="solution-details-column" class="config-select mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="start-date-column" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Coluna Data de Abertura</label>
                                <select id="start-date-column" class="config-select mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm"></select>
                            </div>
                            <div>
                                <label for="start-time-column" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Coluna Hora de Abertura</label>
                                <select id="start-time-column" class="config-select mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm"></select>
                            </div>
                        </div>

                        <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Metas dos Indicadores</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                            <div>
                                <label for="availability-goal-yellow" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Disp. Meta Amarela (>=)</label>
                                <input type="number" id="availability-goal-yellow" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm" value="96" placeholder="Ex: 96">
                            </div>
                            <div>
                                <label for="availability-goal-green" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Disp. Meta Verde (>=)</label>
                                <input type="number" id="availability-goal-green" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm" value="97" placeholder="Ex: 97">
                            </div>
                            <div>
                                <label for="mtbf-goal" class="block text-sm font-medium text-gray-700 dark:text-gray-300">MTBF Meta (>=)</label>
                                <input type="number" id="mtbf-goal" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm" value="90" placeholder="Ex: 90">
                            </div>
                            <div>
                                <label for="mttr-goal" class="block text-sm font-medium text-gray-700 dark:text-gray-300">MTTR Meta (<=)</label>
                                <input type="number" id="mttr-goal" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm" value="2" placeholder="Ex: 2">
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 text-center">
                        <button id="analyze-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg">
                            Analisar Indicadores
                        </button>
                    </div>
                </div>

                <div id="results-section" class="hidden mt-8 max-w-7xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6 text-center text-gray-900 dark:text-white">Resultados da Análise</h2>
                    
                    <div id="kpi-summary-section" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-center">
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">Disponibilidade Fora da Meta</h4>
                            <p id="summary-availability" class="text-3xl font-bold text-red-600 dark:text-red-400">0</p>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">MTTR Fora da Meta</h4>
                            <p id="summary-mttr" class="text-3xl font-bold text-red-600 dark:text-red-400">0</p>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700">
                            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400">MTBF Fora da Meta</h4>
                            <p id="summary-mtbf" class="text-3xl font-bold text-red-600 dark:text-red-400">0</p>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-lg font-semibold text-center mb-2 text-gray-800 dark:text-gray-200">Indicadores por Ativo</h4>
                            <div id="kpi-chart-buttons-asset" class="flex justify-center flex-wrap gap-4">
                                <button data-kpi="availability" data-group-by="asset" class="kpi-chart-btn px-4 py-2 text-sm font-medium rounded-md bg-blue-600 hover:bg-blue-700 text-white">Gráfico Disponibilidade</button>
                                <button data-kpi="mttr" data-group-by="asset" class="kpi-chart-btn px-4 py-2 text-sm font-medium rounded-md bg-blue-600 hover:bg-blue-700 text-white">Gráfico MTTR</button>
                                <button data-kpi="mtbf" data-group-by="asset" class="kpi-chart-btn px-4 py-2 text-sm font-medium rounded-md bg-blue-600 hover:bg-blue-700 text-white">Gráfico MTBF</button>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-center mb-2 text-gray-800 dark:text-gray-200">Indicadores por Centro de Custo</h4>
                            <div id="kpi-chart-buttons-cc" class="flex justify-center flex-wrap gap-4">
                                <button data-kpi="availability" data-group-by="costCenter" class="kpi-chart-btn px-4 py-2 text-sm font-medium rounded-md bg-teal-600 hover:bg-teal-700 text-white">Gráfico Disponibilidade</button>
                                <button data-kpi="mttr" data-group-by="costCenter" class="kpi-chart-btn px-4 py-2 text-sm font-medium rounded-md bg-teal-600 hover:bg-teal-700 text-white">Gráfico MTTR</button>
                                <button data-kpi="mtbf" data-group-by="costCenter" class="kpi-chart-btn px-4 py-2 text-sm font-medium rounded-md bg-teal-600 hover:bg-teal-700 text-white">Gráfico MTBF</button>
                            </div>
                        </div>
                    </div>

                    <div id="results-table-container" class="mt-6 overflow-x-auto bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700"></div>
                </div>

                <div id="error-message" class="hidden mt-6 max-w-7xl mx-auto" role="alert">
                    </div>
            </div>
        </div>

        <div id="chatbot-page" class="page-content hidden h-full flex flex-col">
            <header class="text-center p-4 border-b dark:border-gray-700 flex-shrink-0">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white">Chatbot da Manutenção</h1>
                <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">Converse com seus dados de manutenção.</p>
            </header>
            <div id="chat-container" class="flex-1 p-4 space-y-4 overflow-y-auto flex flex-col">
                </div>
            <div class="p-4 border-t dark:border-gray-700 flex-shrink-0">
                <div class="flex">
                    <input type="text" id="chat-input" class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-l-md" placeholder="Pergunte sobre uma máquina ou problema...">
                    <button id="chat-send-btn" class="bg-indigo-600 text-white px-4 rounded-r-md hover:bg-indigo-700 disabled:bg-indigo-400">Enviar</button>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="pareto-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white dark:bg-gray-800">
        <div class="mt-3">
            <div class="relative text-center mb-2">
                <h3 id="pareto-modal-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Análise de Pareto</h3>
                <div class="absolute top-0 right-0">
                    <button id="print-chart-button" class="p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg" title="Imprimir Gráfico">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm3 0h4v3H8V4zm6 8H6v4h8v-4z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            </div>
            <div id="pareto-sort-controls" class="text-center mb-4">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Classificar por:</span>
                <button id="sort-by-hours" class="px-3 py-1 text-xs font-medium rounded-md bg-indigo-600 text-white">Horas</button>
                <button id="sort-by-frequency" class="px-3 py-1 text-xs font-medium rounded-md bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200">Frequência</button>
            </div>
            <div id="new-category-dropzone" class="text-center p-4 my-2 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-gray-500 dark:text-gray-400">
                Arraste um item aqui para criar uma nova categoria
            </div>
            <div class="mt-2 px-7 py-3">
                <div id="pareto-chart-container">
                    </div>
            </div>
            <div id="pareto-details-container" class="mt-4 px-7 max-h-60 overflow-y-auto"></div>
            <div class="items-center px-4 py-3">
                <button id="pareto-modal-close" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<div id="new-category-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-800">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Criar Nova Categoria</h3>
        <div class="mt-2">
            <input type="text" id="new-category-name" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm" placeholder="Nome da nova categoria">
        </div>
        <div class="mt-4 flex justify-end space-x-2">
            <button id="new-category-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
            <button id="new-category-create" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Criar</button>
        </div>
    </div>
</div>

<div id="rename-category-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-800">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Renomear Categoria</h3>
        <div class="mt-2">
            <input type="hidden" id="old-category-name">
            <input type="text" id="rename-category-name" class="mt-1 block w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-md shadow-sm" placeholder="Novo nome da categoria">
        </div>
        <div class="mt-4 flex justify-end space-x-2">
            <button id="rename-category-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
            <button id="rename-category-save" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Salvar</button>
        </div>
    </div>
</div>

<div id="daily-details-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white dark:bg-gray-800">
        <div class="mt-3">
            <div class="relative text-center mb-4">
                <h3 id="daily-details-modal-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Detalhes do Dia</h3>
                 <div class="absolute top-0 right-0 flex items-center space-x-2">
                    <button id="export-daily-details-button" class="p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg" title="Exportar para Excel">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    </button>
                    <button id="print-daily-details-button" class="p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg" title="Imprimir Detalhes">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm3 0h4v3H8V4zm6 8H6v4h8v-4z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            </div>
            <div id="daily-details-table-container" class="mt-2 px-4 py-3 max-h-[70vh] overflow-y-auto">
                </div>
            <div class="items-center px-4 py-3">
                <button id="daily-details-close" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<div id="kpi-chart-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white dark:bg-gray-800">
        <div class="mt-3 text-center">
            <h3 id="kpi-chart-modal-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Gráfico de KPI</h3>
            <div id="kpi-filter-controls" class="text-center my-4 space-x-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2">Exibir:</span>
                <button data-rank="worst" data-limit="5" class="kpi-filter-btn px-3 py-1 text-xs font-medium rounded-md bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200">Top 5 Piores</button>
                <button data-rank="best" data-limit="5" class="kpi-filter-btn px-3 py-1 text-xs font-medium rounded-md bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200">Top 5 Melhores</button>
                <button data-rank="worst" data-limit="10" class="kpi-filter-btn px-3 py-1 text-xs font-medium rounded-md bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200">Top 10 Piores</button>
                <button data-rank="best" data-limit="10" class="kpi-filter-btn px-3 py-1 text-xs font-medium rounded-md bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200">Top 10 Melhores</button>
                <button data-rank="all" class="kpi-filter-btn px-3 py-1 text-xs font-medium rounded-md bg-indigo-600 text-white">Todos</button>
            </div>
            <div class="mt-2 px-7 py-3">
                <div id="kpi-chart-container">
                    <canvas id="kpi-chart-canvas"></canvas>
                </div>
            </div>
            <div class="items-center px-4 py-3">
                <button id="kpi-modal-close" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>

<div id="solution-guide-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white dark:bg-gray-800">
        <div class="mt-3">
            <div class="relative text-center mb-4">
                <h3 id="solution-guide-title" class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Guia de Soluções com IA</h3>
                <div class="absolute top-0 right-0">
                    <button id="print-solution-guide-button" class="p-2 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg" title="Imprimir Guia">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm3 0h4v3H8V4zm6 8H6v4h8v-4z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            </div>
            <div id="solution-guide-content" class="mt-2 px-4 py-3 max-h-[70vh] overflow-y-auto text-left prose dark:prose-invert">
                </div>
            <div class="items-center px-4 py-3">
                <button id="solution-guide-close" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    Fechar
                </button>
            </div>
        </div>
    </div>
</div>


    <script>
        let domElements = {};
        let jsonData = null;
        let lastResults = [];
        let sortState = { column: 'totalDowntime', direction: 'desc' };
        let globalMinDate = null;
        let globalMaxDate = null;
        let paretoChartInstance = null;
        let kpiChartInstance = null; 
        let dashboardParetoInstance = null;
        let dailyParetoInstance = null;
        let kpiTrendChartInstance = null;
        let currentKpiTrendView = { kpi: 'availability', period: 'monthly' };
        let currentParetoData = null;
        let currentParetoMachineId = null;
        let draggedItemData = null;
        let currentKpiChartType = null;
        let currentDailyDetailsData = null;
        
        const applyTheme = () => {
            const isDarkMode = document.documentElement.classList.contains('dark');
            domElements.themeToggleDarkIcon.classList.toggle('hidden', !isDarkMode);
            domElements.themeToggleLightIcon.classList.toggle('hidden', isDarkMode);
            const colorScheme = isDarkMode ? 'dark' : 'light';
            domElements.reportStartDateInput.style.colorScheme = colorScheme;
            domElements.reportEndDateInput.style.colorScheme = colorScheme;
        };

        const showMessage = (message, type = 'error') => {
            const colorClasses = { error: 'bg-red-100 border-red-400 text-red-700', warning: 'bg-yellow-100 border-yellow-400 text-yellow-800', success: 'bg-green-100 border-green-400 text-green-800' };
            const titles = { error: 'Ocorreu um erro!', warning: 'Aviso:', success: 'Sucesso:' };
            domElements.errorMessageDiv.innerHTML = `<div class="px-4 py-3 rounded-lg ${colorClasses[type]}"><strong class="font-bold">${titles[type] || 'Mensagem:'}</strong> <span class="block sm:inline">${message}</span></div>`;
            domElements.errorMessageDiv.classList.remove('hidden');
        };
        const hideMessage = () => { domElements.errorMessageDiv.classList.add('hidden'); domElements.errorMessageDiv.innerHTML = ''; };
        
        const parseDurationToHours = (value) => {
            if (typeof value === 'number') return value; 
            if (typeof value !== 'string' || value.trim() === '') return NaN;
            if (value.includes(':')) {
                const parts = value.split(':');
                const hours = parseInt(parts[0] || 0, 10);
                const minutes = parseInt(parts[1] || 0, 10);
                const seconds = parseInt(parts[2] || 0, 10);
                if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) return NaN;
                return hours + (minutes / 60) + (seconds / 3600);
            }
            return parseFloat(String(value).replace(/\./g, '').replace(',', '.'));
        };

        function combineDateAndTime(dateVal, timeVal) {
            if (dateVal == null) return null;
            let year, month, day;

            if (dateVal instanceof Date) {
                year = dateVal.getUTCFullYear();
                month = dateVal.getUTCMonth() + 1;
                day = dateVal.getUTCDate();
            } else if (typeof dateVal === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                const dateObj = new Date(excelEpoch.getTime() + dateVal * 86400000);
                year = dateObj.getUTCFullYear();
                month = dateObj.getUTCMonth() + 1;
                day = dateObj.getUTCDate();
            } else if (typeof dateVal === 'string') {
                const parts = String(dateVal).split(' ')[0].split(/[\/-]/);
                if (parts.length === 3) {
                    const p1 = parseInt(parts[0], 10);
                    const p2 = parseInt(parts[1], 10);
                    const p3 = parseInt(parts[2], 10);
                    year = p3.toString().length === 4 ? p3 : (p3 < 50 ? 2000 + p3 : 1900 + p3);
                    if (p1 > 12) { day = p1; month = p2; } 
                    else { month = p1; day = p2; }
                } else { return null; }
            } else { return null; }

            if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
            let dateObj = new Date(Date.UTC(year, month - 1, day));
            if (timeVal != null) {
                if (typeof timeVal === 'number' && timeVal > 0 && timeVal < 1) {
                    const totalSeconds = timeVal * 86400;
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    dateObj.setUTCHours(hours, minutes, 0, 0);
                } else if (typeof timeVal === 'string') {
                    const [hours, minutes, seconds] = timeVal.split(':');
                    dateObj.setUTCHours(parseInt(hours || 0), parseInt(minutes || 0), parseInt(seconds || 0), 0);
                } else if (timeVal instanceof Date) {
                    dateObj.setUTCHours(timeVal.getUTCHours(), timeVal.getUTCMinutes(), timeVal.getUTCSeconds(), 0);
                }
            }
            return dateObj;
        }

        function calculateAndSetTotalHours() {
            const startDateVal = domElements.reportStartDateInput.value;
            const endDateVal = domElements.reportEndDateInput.value;

            if (startDateVal && endDateVal) {
                const startDate = new Date(startDateVal + 'T00:00:00Z');
                const endDate = new Date(endDateVal + 'T00:00:00Z');
                if (endDate < startDate) {
                    showMessage('A Data Final não pode ser anterior à Data Inicial.', 'warning');
                    domElements.totalHoursInput.value = '';
                    return;
                }
                const nextDayAfterEnd = new Date(endDate);
                nextDayAfterEnd.setUTCDate(nextDayAfterEnd.getUTCDate() + 1);
                const diffMilliseconds = nextDayAfterEnd.getTime() - startDate.getTime();
                const totalHours = diffMilliseconds / (1000 * 60 * 60);
                domElements.totalHoursInput.value = totalHours.toFixed(0);
                if(endDate >= startDate) hideMessage();
            } else {
                domElements.totalHoursInput.value = '';
            }
        }
        
        const toYYYYMMDD = (date) => {
             const d = new Date(date);
             const year = d.getUTCFullYear();
             const month = (d.getUTCMonth() + 1).toString().padStart(2, '0');
             const day = d.getUTCDate().toString().padStart(2, '0');
             return `${year}-${month}-${day}`;
        };

        function populateYearSelector() {
            domElements.yearSelect.innerHTML = '<option value="">Ano (Todos)</option>';
            if (!globalMinDate || !globalMaxDate) return;
            const startYear = globalMinDate.getUTCFullYear();
            const endYear = globalMaxDate.getUTCFullYear();
            for (let year = startYear; year <= endYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                domElements.yearSelect.appendChild(option);
            }
            if (domElements.yearSelect.value) {
                populateMonthSelector();
                populateWeekSelector();
            }
        }

        function populateMonthSelector() {
            domElements.monthSelect.innerHTML = '<option value="">Mês (Todos)</option>';
            const year = parseInt(domElements.yearSelect.value);
            if (isNaN(year)) {
                domElements.weekSelect.innerHTML = '<option value="">Semana (Todas)</option>';
                return; 
            }
            const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                domElements.monthSelect.appendChild(option);
            });
            if (domElements.monthSelect.value) {
                populateWeekSelector();
            }
        }

        function populateWeekSelector() {
            domElements.weekSelect.innerHTML = '<option value="">Semana (Todas)</option>';
            const year = parseInt(domElements.yearSelect.value);
            const month = parseInt(domElements.monthSelect.value); 
            if (isNaN(year) || isNaN(month)) return;

            const firstDayOfMonth = new Date(Date.UTC(year, month, 1));
            const lastDayOfMonth = new Date(Date.UTC(year, month + 1, 0));

            let current = new Date(firstDayOfMonth);
            while (current <= lastDayOfMonth) {
                let weekStart = new Date(current);
                weekStart.setUTCDate(weekStart.getUTCDate() - weekStart.getUTCDay());
                
                let weekEnd = new Date(weekStart);
                weekEnd.setUTCDate(weekEnd.getUTCDate() + 6);

                const displayWeekStart = new Date(Math.max(weekStart.getTime(), firstDayOfMonth.getTime()));
                const displayWeekEnd = new Date(Math.min(weekEnd.getTime(), lastDayOfMonth.getTime()));

                const option = document.createElement('option');
                const startStr = displayWeekStart.toLocaleDateString('pt-BR', { timeZone: 'UTC', day: '2-digit', month: '2-digit' });
                const endStr = displayWeekEnd.toLocaleDateString('pt-BR', { timeZone: 'UTC', day: '2-digit', month: '2-digit' });
                
                option.value = `${toYYYYMMDD(weekStart)}|${toYYYYMMDD(weekEnd)}`;
                option.textContent = `Semana de ${startStr} a ${endStr}`;
                domElements.weekSelect.appendChild(option);
                
                current.setUTCDate(current.getUTCDate() + 7);
            }
        }
        
        function handleDateFilterChange() {
            const year = domElements.yearSelect.value;
            const month = domElements.monthSelect.value;
            const week = domElements.weekSelect.value;

            domElements.reportStartDateInput.value = '';
            domElements.reportEndDateInput.value = '';

            if (week) {
                const [start, end] = week.split('|');
                domElements.reportStartDateInput.value = start;
                domElements.reportEndDateInput.value = end;
            } else if (month !== "" && year !== "") {
                const startDate = new Date(Date.UTC(parseInt(year), parseInt(month), 1));
                const endDate = new Date(Date.UTC(parseInt(year), parseInt(month) + 1, 0));
                domElements.reportStartDateInput.value = toYYYYMMDD(startDate);
                domElements.reportEndDateInput.value = toYYYYMMDD(endDate);
            } else if (year !== "") {
                domElements.reportStartDateInput.value = `${year}-01-01`;
                domElements.reportEndDateInput.value = `${year}-12-31`;
            } else { 
                if (globalMinDate && globalMaxDate) {
                    domElements.reportStartDateInput.value = toYYYYMMDD(globalMinDate);
                    domElements.reportEndDateInput.value = toYYYYMMDD(globalMaxDate);
                }
            }

            if (globalMinDate && domElements.reportStartDateInput.value && new Date(domElements.reportStartDateInput.value) < globalMinDate) {
                domElements.reportStartDateInput.value = toYYYYMMDD(globalMinDate);
            }
            if (globalMaxDate && domElements.reportEndDateInput.value && new Date(domElements.reportEndDateInput.value) > globalMaxDate) {
                domElements.reportEndDateInput.value = toYYYYMMDD(globalMaxDate);
            }

            calculateAndSetTotalHours();
        }

        function clearFilters() {
            domElements.yearSelect.value = "";
            domElements.monthSelect.value = "";
            domElements.weekSelect.value = "";
            populateYearSelector();
            handleDateFilterChange();
        }
        
        function populateProductionLineFilter() {
            const filterSelect = domElements.productionLineFilterSelect;
            filterSelect.innerHTML = '<option value="">Todas as Linhas</option>';
            const costCenterCol = domElements.costCenterColumnSelect.value;
            if (!costCenterCol || !jsonData) return;
            const productionLines = new Set();
            jsonData.forEach(row => {
                if (row[costCenterCol]) {
                    productionLines.add(row[costCenterCol]);
                }
            });
            Array.from(productionLines).sort().forEach(line => {
                const option = document.createElement('option');
                option.value = line;
                option.textContent = line;
                filterSelect.appendChild(option);
            });
        }
        
        function updateReportDateRange() {
            const startDateCol = domElements.startDateColumnSelect.value;
            const startTimeCol = domElements.startTimeColumnSelect.value;
            const resetAll = () => {
                globalMinDate = null;
                globalMaxDate = null;
                ['reportStartDateInput', 'reportEndDateInput'].forEach(id => {
                    domElements[id].min = ''; domElements[id].max = ''; domElements[id].value = '';
                });
                domElements.yearSelect.innerHTML = '<option value="">Ano (Todos)</option>';
                domElements.monthSelect.innerHTML = '<option value="">Mês (Todos)</option>';
                domElements.weekSelect.innerHTML = '<option value="">Semana (Todas)</option>';
                populateProductionLineFilter();
            };
            if (!startDateCol || !jsonData) {
                resetAll(); return;
            }
            let minDate = null; let maxDate = null;
            jsonData.forEach(row => {
                const currentDate = combineDateAndTime(row[startDateCol], row[startTimeCol]);
                if (currentDate && !isNaN(currentDate.getTime())) {
                    if (!minDate || currentDate < minDate) minDate = currentDate;
                    if (!maxDate || currentDate > maxDate) maxDate = currentDate;
                }
            });
            if (minDate && maxDate) {
                globalMinDate = minDate;
                globalMaxDate = maxDate;
                const minStr = toYYYYMMDD(minDate);
                const maxStr = toYYYYMMDD(maxDate);
                domElements.reportStartDateInput.min = minStr;
                domElements.reportStartDateInput.max = maxStr;
                domElements.reportEndDateInput.min = minStr;
                domElements.reportEndDateInput.max = maxStr;
                populateYearSelector();
                domElements.reportStartDateInput.value = minStr;
                domElements.reportEndDateInput.value = maxStr;
                calculateAndSetTotalHours();
            } else {
                resetAll();
                showMessage('Não foi possível encontrar datas válidas na coluna selecionada.', 'warning');
            }
        }

        function populateSelectors(headers) {
            const selectors = document.querySelectorAll('.config-select');
            selectors.forEach(sel => sel.innerHTML = '<option value="">-- Selecione a Coluna --</option>');
            headers.forEach(header => {
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                selectors.forEach(sel => sel.appendChild(option.cloneNode(true)));
            });
            autoMapColumns(headers);
        }

        function autoMapColumns(headers) {
            const columnMappings = {
                'machine-column': ['bem', 'ativo', 'maquina', 'equipamento', 'codigo'],
                'asset-name-column': ['nome do bem', 'nome', 'descricao', 'description', 'nome_bem'],
                'downtime-column': ['hora total', 'duracao', 'tempo parada', 'downtime', 'horas', 'total_horas'],
                'service-order-column': ['ordem', 'os', 'service order', 'ordem_servico', 'numero_ordem'],
                'order-title-column': ['titulo', 'title', 'descricao ordem', 'motivo', 'observacao'],
                'start-date-column': ['dt. par. real ini', 'data inicio', 'data abertura', 'start date', 'data_inicio', 'data'],
                'start-time-column': ['hr. par. real ini', 'hora inicio', 'hora abertura', 'start time', 'hora_inicio'],
                'cost-center-column': ['desc. c.custo', 'desc c.custo', 'desc c custo', 'centro de custo', 'linha', 'linha de producao'],
                'solution-details-column': ['insumos', 'detalhe servico', 'acao executada', 'detalhes da solucao', 'servico executado']
            };
            const normalizeString = (str) => str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9\s\.]/g, '').trim();
            Object.keys(columnMappings).forEach(selectId => {
                const selectElement = document.getElementById(selectId);
                if (!selectElement) return;
                const patterns = columnMappings[selectId];
                let matchedHeader = null;
                for (const header of headers) {
                    const normalizedHeader = normalizeString(header);
                    if (patterns.some(p => normalizedHeader === normalizeString(p))) { matchedHeader = header; break; }
                }
                if (!matchedHeader) {
                    for (const header of headers) {
                        const normalizedHeader = normalizeString(header);
                        if (patterns.some(p => normalizedHeader.includes(normalizeString(p)))) { matchedHeader = header; break; }
                    }
                }
                if (matchedHeader && selectElement) {
                    selectElement.value = matchedHeader;
                    selectElement.style.backgroundColor = '#dcfce7'; selectElement.style.borderColor = '#16a34a';
                    setTimeout(() => { selectElement.style.backgroundColor = ''; selectElement.style.borderColor = ''; }, 3000);
                }
            });
            const autoFilledFields = Array.from(document.querySelectorAll('.config-select')).filter(sel => sel.value !== '').length;
            if (autoFilledFields > 0) {
                showMessage(`${autoFilledFields} de 9 campos de análise principal foram preenchidos. Verifique se estão corretos.`, 'success');
            }
        }

        function runAnalysis() {
            hideMessage();
            if (!jsonData) return showMessage("Por favor, carregue uma planilha primeiro.");
            const config = {
                totalHours: parseFloat(domElements.totalHoursInput.value),
                machineCol: domElements.machineColumnSelect.value,
                assetNameCol: domElements.assetNameColumnSelect.value,
                downtimeCol: domElements.downtimeColumnSelect.value,
                serviceOrderCol: domElements.serviceOrderColumnSelect.value,
                orderTitleCol: domElements.orderTitleColumnSelect.value,
                startDateCol: domElements.startDateColumnSelect.value,
                startTimeCol: domElements.startTimeColumnSelect.value,
                costCenterCol: domElements.costCenterColumnSelect.value,
                solutionDetailsCol: domElements.solutionDetailsColumnSelect.value,
                selectedProductionLine: domElements.productionLineFilterSelect.value,
            };
            if (!config.totalHours || config.totalHours <= 0) return showMessage("Por favor, selecione um período válido.");
            if (!config.machineCol || !config.downtimeCol) return showMessage("Por favor, mapeie as colunas de Ativos e Duração.");
            if (!config.startDateCol) return showMessage("Por favor, mapeie a Coluna Data de Abertura.");
            try {
                processAndDisplayKpis(config);
                domElements.resultsSection.classList.remove('hidden');
            } catch(err) {
                console.error(err);
                showMessage(err.message || "Ocorreu um erro ao processar os dados.");
                domElements.resultsSection.classList.add('hidden');
            }
        }
        
        function processAndDisplayKpis(config) {
            const aggregatedData = {};
            let invalidRows = 0;
            const reportEndDate = new Date(domElements.reportEndDateInput.value + 'T23:59:59Z');
            const reportStartDate = new Date(domElements.reportStartDateInput.value + 'T00:00:00Z');
            
            let initialData = jsonData;
            if (config.selectedProductionLine && config.costCenterCol) {
                initialData = jsonData.filter(row => row[config.costCenterCol] == config.selectedProductionLine);
            }
            
            const filteredData = initialData.filter(row => {
                const startDateTime = combineDateAndTime(row[config.startDateCol], row[config.startTimeCol]);
                return startDateTime && startDateTime >= reportStartDate && startDateTime <= reportEndDate;
            });

            filteredData.forEach((row) => {
                const machineId = row[config.machineCol];
                if (!machineId) { invalidRows++; return; }
                const downtimeHours = parseDurationToHours(row[config.downtimeCol]);
                const startDateTime = combineDateAndTime(row[config.startDateCol], row[config.startTimeCol]);
                if (isNaN(downtimeHours) || !startDateTime) { invalidRows++; return; }
                if (!aggregatedData[machineId]) {
                    aggregatedData[machineId] = { 
                        description: row[config.assetNameCol] || '', 
                        costCenter: row[config.costCenterCol] || 'N/D',
                        totalDowntime: 0, 
                        totalEvents: 0, 
                        orders: [], 
                        lastStopTime: null 
                    };
                }
                aggregatedData[machineId].totalDowntime += downtimeHours;
                aggregatedData[machineId].totalEvents += 1;
                aggregatedData[machineId].orders.push({ 
                    serviceOrder: row[config.serviceOrderCol] || 'N/A', 
                    title: row[config.orderTitleCol] || 'N/A', 
                    solution: row[config.solutionDetailsCol] || '',
                    startDateTime: startDateTime, 
                    downtime: downtimeHours 
                });
                if (!aggregatedData[machineId].lastStopTime || startDateTime > aggregatedData[machineId].lastStopTime) {
                    aggregatedData[machineId].lastStopTime = startDateTime;
                }
            });

            if (Object.keys(aggregatedData).length === 0) {
                domElements.resultsSection.classList.add('hidden');
                return showMessage("Nenhum dado válido encontrado no período selecionado. Verifique os filtros e o mapeamento.", 'error');
            }
            if (invalidRows > 0) showMessage(`${invalidRows} linhas foram ignoradas por dados ausentes ou formato inválido.`, 'warning');

            lastResults = Object.keys(aggregatedData).map(machineId => {
                const data = aggregatedData[machineId];
                const { description, costCenter, totalDowntime, totalEvents, orders, lastStopTime } = data;
                const uptime = Math.max(0, config.totalHours - totalDowntime);
                const availability = config.totalHours > 0 ? (uptime / config.totalHours) * 100 : 0;
                const mtbf = (totalEvents > 0) ? (uptime / totalEvents) : uptime;
                const mttr = (totalEvents > 0) ? (totalDowntime / totalEvents) : 0;
                
                const weeklyAvailability = [];
                const WEEKS_TO_SHOW = 5;
                const HOURS_IN_WEEK = 168; // 7 * 24
                const endDateForChart = new Date(domElements.reportEndDateInput.value + 'T23:59:59Z');

                for (let i = 0; i < WEEKS_TO_SHOW; i++) {
                    const weekEndDate = new Date(endDateForChart.getTime() - (i * 7 * 24 * 60 * 60 * 1000));
                    const weekStartDate = new Date(weekEndDate.getTime() - (7 * 24 * 60 * 60 * 1000));

                    const weeklyDowntime = orders
                        .filter(order => order.startDateTime >= weekStartDate && order.startDateTime < weekEndDate)
                        .reduce((sum, order) => sum + order.downtime, 0);

                    const weeklyUptime = Math.max(0, HOURS_IN_WEEK - weeklyDowntime);
                    const weeklyAvail = (weeklyUptime / HOURS_IN_WEEK) * 100;
                    
                    weeklyAvailability.push({
                        weekStart: weekStartDate,
                        weekEnd: weekEndDate,
                        availability: weeklyAvail
                    });
                }
                weeklyAvailability.reverse(); 

                orders.sort((a,b) => b.startDateTime.getTime() - a.startDateTime.getTime());
                return { machineId, description, costCenter, totalDowntime, totalEvents, availability, mtbf, mttr, orders, lastStopTime, weeklyAvailability };
            });

            const goals = {
                availabilityYellow: parseFloat(domElements.availabilityGoalYellowInput.value),
                mtbf: parseFloat(domElements.mtbfGoalInput.value),
                mttr: parseFloat(domElements.mttrGoalInput.value)
            };

            let availabilityOffGoal = 0;
            let mttrOffGoal = 0;
            let mtbfOffGoal = 0;

            lastResults.forEach(res => {
                if (res.availability < goals.availabilityYellow) {
                    availabilityOffGoal++;
                }
                if (res.mttr > goals.mttr) {
                    mttrOffGoal++;
                }
                if (res.mtbf < goals.mtbf) {
                    mtbfOffGoal++;
                }
            });

            domElements.summaryAvailability.textContent = availabilityOffGoal;
            domElements.summaryMttr.textContent = mttrOffGoal;
            domElements.summaryMtbf.textContent = mtbfOffGoal;
            
            sortAndRenderResults();
            
            // Setup dashboard slider
            const maxMachines = lastResults.length > 1 ? lastResults.length : 1;
            domElements.dashboardParetoSlider.max = maxMachines;
            const initialSliderValue = Math.min(10, maxMachines);
            domElements.dashboardParetoSlider.value = initialSliderValue;
            domElements.dashboardParetoSliderValue.textContent = initialSliderValue;

            generateDashboardPareto();
            generateDailyParetoChart();
            generateKpiTrendChart();
        }

        function sortAndRenderResults() {
            const { column, direction } = sortState;
            lastResults.sort((a, b) => {
                const valA = a[column]; const valB = b[column];
                if (valA instanceof Date) { return direction === 'asc' ? valA - valB : valB - valA; }
                if (typeof valA === 'string') { return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA); }
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            renderResultsTable(lastResults);
        }
        
        function printMachineDetails(machineId) {
            const machineData = lastResults.find(res => String(res.machineId) === String(machineId));
            if (!machineData) {
                showMessage('Dados da máquina não encontrados.', 'error');
                return;
            }

            const goals = {
                availabilityGreen: parseFloat(domElements.availabilityGoalGreenInput.value),
                availabilityYellow: parseFloat(domElements.availabilityGoalYellowInput.value),
                mtbf: parseFloat(domElements.mtbfGoalInput.value),
                mttr: parseFloat(domElements.mttrGoalInput.value)
            };

            let availabilityColor;
            if (machineData.availability >= goals.availabilityGreen) availabilityColor = 'color: #166534; background-color: #dcfce7;';
            else if (machineData.availability >= goals.availabilityYellow) availabilityColor = 'color: #854d0e; background-color: #fefce8;';
            else availabilityColor = 'color: #991b1b; background-color: #fee2e2;';
            const mtbfColor = machineData.mtbf >= goals.mtbf ? 'color: #16a34a;' : 'color: #dc2626;';
            const mttrColor = machineData.mttr <= goals.mttr ? 'color: #16a34a;' : 'color: #dc2626;';
            const formatDate = (date) => (!date || isNaN(date)) ? 'N/A' : date.toLocaleDateString('pt-BR', { timeZone: 'UTC', day: '2-digit', month: '2-digit', year: 'numeric' });
            const formatDateTime = (date) => (!date || isNaN(date)) ? 'N/A' : date.toLocaleString('pt-BR', { timeZone: 'UTC', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

            const printContent = `
                <html>
                <head>
                    <title>Relatório - ${machineData.machineId}</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
                        body { font-family: 'Inter', sans-serif; margin: 20px; font-size: 12px; }
                        h1, h2, h3 { font-family: 'Inter', sans-serif; }
                        h1 { text-align: center; }
                        h2 { text-align: center; color: #555; font-weight: 500;}
                        h3 { border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 30px;}
                        .kpi-container { display: flex; justify-content: space-around; text-align: center; margin: 20px 0; padding: 10px; border-top: 1px solid #eee; border-bottom: 1px solid #eee; }
                        .kpi-item { flex-grow: 1; padding: 5px; }
                        .kpi-item strong { display: block; font-size: 1.2em; font-weight: 600; margin-top: 4px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: 600; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                    </style>
                </head>
                <body>
                    <h1>Relatório de Indicadores de Manutenção</h1>
                    <h2>Ativo: ${machineData.machineId} - ${machineData.description}</h2>

                    <div class="kpi-container">
                        <div class="kpi-item">Disponibilidade<br><strong style="${availabilityColor} padding: 4px; border-radius: 4px;">${machineData.availability.toFixed(2)}%</strong></div>
                        <div class="kpi-item">MTBF (h)<br><strong style="${mtbfColor}">${machineData.mtbf.toFixed(2)}</strong></div>
                        <div class="kpi-item">MTTR (h)<br><strong style="${mttrColor}">${machineData.mttr.toFixed(2)}</strong></div>
                        <div class="kpi-item">Nº de Paradas<br><strong>${machineData.totalEvents}</strong></div>
                        <div class="kpi-item">Horas Paradas<br><strong>${machineData.totalDowntime.toFixed(2)}</strong></div>
                        <div class="kpi-item">Última Parada<br><strong>${formatDate(machineData.lastStopTime)}</strong></div>
                    </div>

                    <h3>Detalhes das Paradas no Período</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>OS</th>
                                <th>Título</th>
                                <th>Data/Hora Abertura</th>
                                <th>Duração (h)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${machineData.orders.map(order => `
                                <tr>
                                    <td>${order.serviceOrder}</td>
                                    <td>${order.title}</td>
                                    <td>${formatDateTime(order.startDateTime)}</td>
                                    <td>${order.downtime.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { 
                printWindow.print();
                printWindow.close();
            }, 250);
        }
        
        function generateSparkline(data) {
            if (!data || data.length < 2) { 
                return '<span class="text-xs text-gray-400">Dados insuficientes</span>';
            }
            
            const width = 120;
            const height = 30;
            const strokeWidth = 1.5;
            const padding = 4;
            
            const minY = 60;
            const maxY = 100;
            const rangeY = maxY - minY;

            const effectiveHeight = height - (2 * padding);
            const xStep = (width - 2 * padding) / (data.length - 1);

            const points = data.map((d, i) => {
                const x = padding + (i * xStep);
                const clampedValue = Math.max(minY, Math.min(maxY, d.availability));
                const normalizedValue = rangeY > 0 ? (clampedValue - minY) / rangeY : 0;
                const y = padding + effectiveHeight - (normalizedValue * effectiveHeight);
                return `${x.toFixed(2)},${y.toFixed(2)}`;
            }).join(' ');

            const circles = data.map((d, i) => {
                const x = padding + (i * xStep);
                const clampedValue = Math.max(minY, Math.min(maxY, d.availability));
                const normalizedValue = rangeY > 0 ? (clampedValue - minY) / rangeY : 0;
                const y = padding + effectiveHeight - (normalizedValue * effectiveHeight);
                const weekStartDate = d.weekStart.toLocaleDateString('pt-BR', {timeZone: 'UTC', day: '2-digit', month: '2-digit'});
                return `<circle cx="${x.toFixed(2)}" cy="${y.toFixed(2)}" r="2" class="fill-indigo-600 dark:fill-indigo-400"><title>Semana de ${weekStartDate}: ${d.availability.toFixed(1)}%</title></circle>`;
            }).join('');

            const isTrendingUp = data[data.length - 1].availability >= data[0].availability;
            const lineColor = isTrendingUp ? 'stroke-green-500' : 'stroke-red-500';

            return `<svg viewBox="0 0 ${width} ${height}" class="w-32 h-auto group" aria-hidden="true">
                <polyline fill="none" class="${lineColor}" stroke-width="${strokeWidth}" points="${points}" />
                ${circles}
            </svg>`;
        }
        
        /**
         * A robust fetch wrapper that handles API calls with exponential backoff for retries.
         * @param {string} apiUrl The API endpoint to call.
         * @param {object} payload The JSON payload to send.
         * @param {number} maxRetries The maximum number of retry attempts.
         * @returns {Promise<object>} The JSON response from the API.
         */
        async function fetchWithBackoff(apiUrl, payload, maxRetries = 5) {
            let delay = 1000; // Start with 1 second
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    }

                    // Don't retry on client-side errors (4xx), except for 429 (Too Many Requests)
                    if (response.status >= 400 && response.status < 500 && response.status !== 429) {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMessage = errorData.error?.message || response.statusText;
                        throw new Error(`Erro do Cliente: ${response.status} ${errorMessage}`);
                    }
                    
                    // Do not log retry attempts to the user console. This is for internal debugging.

                } catch (error) {
                    if (i === maxRetries - 1) throw error; // Re-throw the last error
                }

                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2; // Double the delay for the next retry
            }
            throw new Error(`A chamada à API falhou após ${maxRetries} tentativas.`);
        }

        async function analyzeWithGemini(ordersData, buttonElement) {
            buttonElement.disabled = true;
            buttonElement.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-700 dark:text-gray-300 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            
            const dataWithIds = ordersData.map((order, index) => ({ ...order, originalId: index }));
            
            const prompt = `Analise a seguinte lista de ordens de manutenção (com 'title', 'downtime' e 'originalId'). Agrupe problemas que são semanticamente similares. Para cada grupo, crie um "problemGroup" curto. Calcule a "frequency" (número de ocorrências) e "totalHours" (soma dos downtimes) para cada grupo. Para cada grupo, retorne também um array "orderIds" contendo os 'originalId' das ordens que pertencem a ele. O resultado final deve ser um array de objetos JSON. Exemplo de agrupamento: "motor quebrou" e "falha no motor principal" devem ser agrupados em "Falha de Motor". Dados: ${JSON.stringify(dataWithIds)}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "problemGroup": { "type": "STRING" },
                                "frequency": { "type": "NUMBER" },
                                "totalHours": { "type": "NUMBER" },
                                "orderIds": { "type": "ARRAY", "items": { "type": "NUMBER" } }
                            },
                            required: ["problemGroup", "frequency", "totalHours", "orderIds"]
                        }
                    }
                }
            };
            
            const apiKey = "AIzaSyDwTbJWhdnP2Fyz2yjEo7D_3sDnieknz1w"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const result = await fetchWithBackoff(apiUrl, payload);
                
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    return JSON.parse(text);
                } else {
                    throw new Error("Resposta da API inválida ou vazia.");
                }
            } catch (error) {
                console.error("Erro ao analisar com Gemini:", error);
                showMessage(`Erro na análise com IA: ${error.message}`, 'error');
                return null;
            } finally {
                buttonElement.disabled = false;
                buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v0A2.5 2.5 0 0 1 9.5 7v0A2.5 2.5 0 0 1 7 9.5v0A2.5 2.5 0 0 1 9.5 12v0A2.5 2.5 0 0 1 7 14.5v0A2.5 2.5 0 0 1 9.5 17v0A2.5 2.5 0 0 1 7 19.5v0a2.5 2.5 0 0 1 2.5 2.5"/><path d="M14.5 2a2.5 2.5 0 0 0-2.5 2.5v0A2.5 2.5 0 0 0 14.5 7v0A2.5 2.5 0 0 0 17 9.5v0A2.5 2.5 0 0 0 14.5 12v0A2.5 2.5 0 0 0 17 14.5v0A2.5 2.5 0 0 0 14.5 17v0A2.5 2.5 0 0 0 17 19.5v0a2.5 2.5 0 0 0-2.5 2.5"/></svg>`;
            }
        }
        
        function createParetoChart(data, machineId, sortBy = 'hours') {
            if (paretoChartInstance) {
                paretoChartInstance.destroy();
            }
            domElements.paretoChartContainer.innerHTML = '';
            const canvas = document.createElement('canvas');
            domElements.paretoChartContainer.appendChild(canvas);
            
            currentParetoData = data;
            currentParetoMachineId = machineId;

            const sortedByHours = [...data].sort((a, b) => b.totalHours - a.totalHours);
            const totalHoursSum = sortedByHours.reduce((sum, item) => sum + item.totalHours, 0);
            
            let displayData = [...data];
            if (sortBy === 'hours') {
                displayData.sort((a, b) => b.totalHours - a.totalHours);
            } else {
                displayData.sort((a, b) => b.frequency - a.frequency);
            }

            const labels = displayData.map(item => item.problemGroup);
            const hoursData = displayData.map(item => item.totalHours.toFixed(2));
            const frequencyData = displayData.map(item => item.frequency);

            const paretoMap = new Map();
            let cumulativeHours = 0;
            sortedByHours.forEach(item => {
                cumulativeHours += item.totalHours;
                paretoMap.set(item.problemGroup, (cumulativeHours / totalHoursSum) * 100);
            });
            const paretoLineData = displayData.map(item => paretoMap.get(item.problemGroup).toFixed(2));

            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#E5E7EB' : '#1F2937';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const maxValue = Math.max(...hoursData, ...frequencyData);

            paretoChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Horas de Parada',
                            data: hoursData,
                            backgroundColor: 'rgba(79, 70, 229, 0.8)', // Indigo
                            yAxisID: 'y',
                        },
                        {
                            label: 'Frequência de Falhas',
                            data: frequencyData,
                            backgroundColor: 'rgba(219, 39, 119, 0.8)', // Pink
                            yAxisID: 'y',
                        },
                        {
                            label: 'Percentual Acumulado (Horas)',
                            data: paretoLineData,
                            type: 'line',
                            borderColor: 'rgba(234, 179, 8, 1)', // Amber
                            backgroundColor: 'rgba(234, 179, 8, 0.2)',
                            fill: false,
                            yAxisID: 'y1',
                            tension: 0.1,
                            datalabels: {
                                display: false 
                            }
                        }
                    ]
                },
                plugins: [ChartDataLabels],
                options: {
                    onClick: (event, elements) => { 
                        if (elements.length > 0) {
                            const chart = paretoChartInstance;
                            const elementIndex = elements[0].index;
                            const clickedLabel = chart.data.labels[elementIndex];
                            displayParetoDetails(clickedLabel);
                        }
                    }, 
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        datalabels: {
                            display: true,
                            rotation: -90,
                            align: 'end',
                            anchor: 'end',
                            color: textColor,
                            font: {
                                size: 10,
                                weight: 'bold',
                            },
                            formatter: (value) => parseFloat(value).toFixed(1),
                        },
                        legend: { labels: { color: textColor } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.dataset.yAxisID === 'y1') {
                                        label += parseFloat(context.raw).toFixed(2) + '%';
                                    } else if (context.dataset.label === 'Horas de Parada') {
                                        label += parseFloat(context.raw).toFixed(2) + ' horas';
                                    } else {
                                        label += context.raw;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: textColor }, grid: { color: gridColor } },
                        y: {
                            beginAtZero: true,
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Valor (Horas / Frequência)', color: textColor },
                            ticks: { color: textColor },
                            grid: { color: gridColor },
                            max: maxValue * 1.25 
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            title: { display: true, text: 'Percentual Acumulado (%)', color: textColor },
                            ticks: { color: textColor, callback: value => value + '%' },
                            grid: { drawOnChartArea: false },
                        }
                    }
                }
            });

            domElements.paretoModalTitle.textContent = `Análise de Pareto para o Ativo: ${machineId}`;
            domElements.paretoModal.classList.remove('hidden');
            domElements.paretoDetailsContainer.innerHTML = '';
        }

        function displayParetoDetails(problemGroup) {
            const machineData = lastResults.find(res => String(res.machineId) === String(currentParetoMachineId));
            const groupData = currentParetoData.find(d => d.problemGroup === problemGroup);
            if (!machineData || !groupData) {
                domElements.paretoDetailsContainer.innerHTML = '';
                return;
            }

            const orderIds = new Set(groupData.orderIds);
            const relevantOrders = machineData.orders.filter((order, index) => orderIds.has(index));
            
            const formatDateTime = (date) => (!date || isNaN(date)) ? 'N/A' : date.toLocaleString('pt-BR', { timeZone: 'UTC', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            
            let detailsHTML = `
                <div class="flex justify-between items-center mb-2 border-t border-gray-200 dark:border-gray-700 pt-4">
                    <div class="flex items-center gap-2">
                        <h4 class="text-md font-semibold text-gray-800 dark:text-gray-200">${problemGroup}</h4>
                        <button class="rename-category-button text-gray-400 hover:text-indigo-500" data-problem-group="${problemGroup}" title="Renomear Categoria">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="export-pareto-details-button text-gray-500 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400 p-1 rounded-md" data-problem-group="${problemGroup}" title="Exportar Detalhes para Excel">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        </button>
                        <button class="solution-guide-button text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-300 p-1 rounded-md" data-problem-group="${problemGroup}" title="Gerar Guia de Soluções para este Problema">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5h.01M8.25 10.5h.01M8.25 13.5h.01M15.75 7.5h.01M15.75 10.5h.01M15.75 13.5h.01" />
                            </svg>
                        </button>
                    </div>
                </div>
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 dark:bg-gray-700">
                        <tr>
                            <th class="px-2 py-1">OS</th>
                            <th class="px-2 py-1">Título</th>
                            <th class="px-2 py-1">Data/Hora</th>
                            <th class="px-2 py-1 text-right">Duração (h)</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-700 dark:text-gray-300">
                        ${relevantOrders.map((order) => {
                            const originalIndex = machineData.orders.findIndex(o => o.serviceOrder === order.serviceOrder && o.title === order.title && o.downtime === order.downtime);
                            return `<tr class="border-b border-gray-200 dark:border-gray-700 draggable-row" draggable="true" data-order-id="${originalIndex}">
                                <td>${order.serviceOrder}</td>
                                <td>${order.title}</td>
                                <td>${formatDateTime(order.startDateTime)}</td>
                                <td class="px-2 py-1 text-right">${order.downtime.toFixed(2)}</td>
                            </tr>`
                        }).join('')}
                    </tbody>
                </table>
            `;

            domElements.paretoDetailsContainer.innerHTML = detailsHTML;
            addParetoDetailsEventListeners();
            addDragAndDropListeners();
        }
        
        function renderResultsTable(results) {
            const goals = {
                availabilityGreen: parseFloat(domElements.availabilityGoalGreenInput.value),
                availabilityYellow: parseFloat(domElements.availabilityGoalYellowInput.value),
                mtbf: parseFloat(domElements.mtbfGoalInput.value),
                mttr: parseFloat(domElements.mttrGoalInput.value)
            };
            const getSortIcon = (columnName) => (sortState.column === columnName) ? (sortState.direction === 'asc' ? '▲' : '▼') : '';
            const formatDate = (date) => (!date || isNaN(date)) ? 'N/A' : date.toLocaleDateString('pt-BR', { timeZone: 'UTC', day: '2-digit', month: '2-digit', year: 'numeric' });
            const formatDateTime = (date) => (!date || isNaN(date)) ? 'N/A' : date.toLocaleString('pt-BR', { timeZone: 'UTC', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            
            let tableHTML = `<table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700"><thead class="bg-gray-50 dark:bg-gray-700"><tr>
                <th class="px-2 py-3"></th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-column="machineId">Ativo</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-column="description">Descrição</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-column="totalDowntime">H.Paradas</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-column="totalEvents">Nº Paradas</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-column="availability">Dispon.</th>
                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tendência (5 sem.)</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-column="mtbf">MTBF (h)</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-column="mttr">MTTR (h)</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-column="lastStopTime">Últ. Parada</th>
            </tr></thead><tbody id="results-tbody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">`;
            
            if (results.length === 0) {
                tableHTML += `<tr><td colspan="10" class="text-center py-4">Nenhum dado para exibir.</td></tr>`;
            } else {
                results.forEach((res, resIndex) => {
                    let availabilityColor;
                    if (res.availability >= goals.availabilityGreen) availabilityColor = 'bg-green-100 text-green-800';
                    else if (res.availability >= goals.availabilityYellow) availabilityColor = 'bg-yellow-100 text-yellow-800';
                    else availabilityColor = 'bg-red-100 text-red-800';
                    const mtbfColor = res.mtbf >= goals.mtbf ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                    const mttrColor = res.mttr <= goals.mttr ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                    const machineIdSafe = String(res.machineId).replace(/[^a-zA-Z0-9]/g, '');

                    const sparklineHTML = generateSparkline(res.weeklyAvailability);
                    tableHTML += `<tr class="main-row">
                        <td class="px-2 py-4"><span class="toggle-details" data-target="details-for-${machineIdSafe}">+</span></td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${res.machineId}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${res.description}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${res.totalDowntime.toFixed(2)}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${res.totalEvents}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm font-semibold"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${availabilityColor}">${res.availability.toFixed(2)}%</span></td>
                        <td class="px-3 py-4 whitespace-nowrap">${sparklineHTML}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm font-semibold ${mtbfColor}">${res.mtbf.toFixed(2)}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm font-semibold ${mttrColor}">${res.mttr.toFixed(2)}</td>
                        <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatDate(res.lastStopTime)}</td>
                    </tr>
                    
                    <tr class="details-row details-for-${machineIdSafe} bg-gray-50 dark:bg-gray-900"><td colspan="11" class="p-0"><div class="p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-sm font-semibold text-gray-800 dark:text-gray-200">Detalhes das Paradas (${res.orders.length})</h4>
                            <div class="flex items-center space-x-2">
                                <button class="export-excel-button text-gray-500 dark:text-gray-400 hover:text-green-600 dark:hover:text-green-400 p-1 rounded-md" data-machine-id-for-excel="${res.machineId}" title="Exportar para Excel">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                </button>
                                <button class="print-button text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-300 p-1 rounded-md" data-machine-id-to-print="${res.machineId}" title="Imprimir Relatório da Máquina">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm3 0h4v3H8V4zm6 8H6v4h8v-4z" clip-rule="evenodd"></path></svg>
                                </button>
                                <button class="pareto-analysis-button text-gray-500 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-300 p-1 rounded-md" data-machine-id-for-pareto="${res.machineId}" title="Analisar Causas com IA">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v0A2.5 2.5 0 0 1 9.5 7v0A2.5 2.5 0 0 1 7 9.5v0A2.5 2.5 0 0 1 9.5 12v0A2.5 2.5 0 0 1 7 14.5v0A2.5 2.5 0 0 1 9.5 17v0A2.5 2.5 0 0 1 7 19.5v0a2.5 2.5 0 0 1 2.5 2.5"/><path d="M14.5 2a2.5 2.5 0 0 0-2.5 2.5v0A2.5 2.5 0 0 0 14.5 7v0A2.5 2.5 0 0 0 17 9.5v0A2.5 2.5 0 0 0 14.5 12v0A2.5 2.5 0 0 0 17 14.5v0A2.5 2.5 0 0 0 14.5 17v0A2.5 2.5 0 0 0 17 19.5v0a2.5 2.5 0 0 0-2.5 2.5"/></svg>
                                </button>
                            </div>
                        </div>
                        <table class="min-w-full"><thead><tr class="text-xs text-left text-gray-600 dark:text-gray-400"><th class="py-1 px-2">OS</th><th class="py-1 px-2">Título</th><th class="py-1 px-2">Data/Hora Abertura</th><th class="py-1 px-2">Duração (h)</th></tr></thead><tbody>
                        ${res.orders.map((order, orderIndex) => `
                            <tr class="border-t border-gray-200 dark:border-gray-700">
                                <td class="px-1 py-1">${order.serviceOrder}</td>
                                <td class="px-1 py-1">
                                    <a class="order-title-toggle" data-target-id="solution-${resIndex}-${orderIndex}">${order.title}</a>
                                    <div id="solution-${resIndex}-${orderIndex}" class="solution-details">${order.solution || 'Nenhum detalhe informado.'}</div>
                                </td>
                                <td class="px-1 py-1">${formatDateTime(order.startDateTime)}</td>
                                <td class="px-1 py-1 text-right">${order.downtime.toFixed(2)}</td>
                            </tr>`).join('')}
                        </tbody></table></div></td></tr>`;
                });
            }
            tableHTML += `</tbody></table>`;
            domElements.resultsTableContainer.innerHTML = tableHTML;
            addTableEventListeners();
        }

        function addTableEventListeners() {
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.column;
                    if (sortState.column === column) {
                        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.column = column; sortState.direction = 'desc';
                    }
                    sortAndRenderResults();
                });
            });
            document.querySelectorAll('.toggle-details').forEach(toggle => {
                toggle.addEventListener('click', (event) => {
                    const targetClass = event.target.dataset.target;
                    const detailRow = document.querySelector(`tr.${targetClass}`);
                    if (detailRow) {
                        const isVisible = detailRow.style.display === 'table-row';
                        detailRow.style.display = isVisible ? 'none' : 'table-row';
                        event.target.textContent = isVisible ? '+' : '-';
                    }
                });
            });
            document.querySelectorAll('.order-title-toggle').forEach(title => {
                title.addEventListener('click', (event) => {
                    event.preventDefault();
                    const targetId = event.target.dataset.targetId;
                    const detailDiv = document.getElementById(targetId);
                    if (detailDiv) {
                        const isVisible = detailDiv.style.display === 'block';
                        detailDiv.style.display = isVisible ? 'none' : 'block';
                    }
                });
            });
            document.querySelectorAll('.print-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const machineId = event.currentTarget.dataset.machineIdToPrint;
                    printMachineDetails(machineId);
                });
            });
            document.querySelectorAll('.pareto-analysis-button').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const machineId = event.currentTarget.dataset.machineIdForPareto;
                    const machineData = lastResults.find(res => String(res.machineId) === String(machineId));
                    if (machineData && machineData.orders.length > 0) {
                        const ordersToAnalyze = machineData.orders.map((o, index) => ({ originalId: index, title: o.title, downtime: o.downtime }));
                        const analysisResult = await analyzeWithGemini(ordersToAnalyze, event.currentTarget);
                        if (analysisResult) {
                            createParetoChart(analysisResult, machineId, 'hours');
                        }
                    } else {
                        showMessage('Não há dados de parada para analisar para esta máquina.', 'warning');
                    }
                });
            });
            document.querySelectorAll('.export-excel-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    const machineId = event.currentTarget.dataset.machineIdForExcel;
                    exportMachineDetailsToExcel(machineId);
                });
            });
        }
        
        function exportMachineDetailsToExcel(machineId) {
            const machineData = lastResults.find(res => String(res.machineId) === String(machineId));
            if (!machineData) {
                showMessage('Dados da máquina não encontrados para exportação.', 'error');
                return;
            }

            const formatDateTime = (date) => (!date || isNaN(date)) ? 'N/A' : date.toLocaleString('pt-BR', { timeZone: 'UTC' });

            const dataForSheet = machineData.orders.map(order => ({
                'OS': order.serviceOrder,
                'Título': order.title,
                'Detalhes/Insumos': order.solution,
                'Data/Hora Abertura': formatDateTime(order.startDateTime),
                'Duração (h)': order.downtime
            }));

            const ws = XLSX.utils.json_to_sheet(dataForSheet);

            ws['!cols'] = [
                { wch: 15 }, // OS
                { wch: 50 }, // Título
                { wch: 60 }, // Detalhes/Insumos
                { wch: 20 }, // Data/Hora Abertura
                { wch: 15 }  // Duração (h)
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Detalhes Paradas');
            XLSX.writeFile(wb, `Detalhes_Paradas_${machineId}.xlsx`);
        }
        
        function addDragAndDropListeners() {
            const chartCanvas = domElements.paretoChartContainer.querySelector('canvas');
            const newCategoryDropzone = domElements.newCategoryDropzone;

            [chartCanvas, newCategoryDropzone].forEach(el => {
                el.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    el.classList.add('drop-target-highlight');
                });
                el.addEventListener('dragleave', (e) => {
                    el.classList.remove('drop-target-highlight');
                });
            });

            chartCanvas.addEventListener('drop', (e) => {
                e.preventDefault();
                chartCanvas.classList.remove('drop-target-highlight');
                const droppedOnElements = paretoChartInstance.getElementsAtEventForMode(e, 'index', { intersect: false }, true);
                if (droppedOnElements.length > 0 && draggedItemData) {
                    const droppedIndex = droppedOnElements[0].index;
                    const destinationGroup = paretoChartInstance.data.labels[droppedIndex];
                    updateParetoData(draggedItemData.orderId, destinationGroup);
                    draggedItemData = null;
                }
            });
            
            newCategoryDropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                newCategoryDropzone.classList.remove('drop-target-highlight');
                if (draggedItemData) {
                    domElements.newCategoryModal.classList.remove('hidden');
                    domElements.newCategoryNameInput.focus();
                }
            });

            document.querySelectorAll('#pareto-details-container .draggable-row').forEach(row => {
                row.addEventListener('dragstart', (e) => {
                    const orderId = parseInt(e.currentTarget.dataset.orderId);
                    draggedItemData = { orderId };
                    e.dataTransfer.effectAllowed = 'move';
                    e.currentTarget.style.opacity = '0.4';
                });

                row.addEventListener('dragend', (e) => {
                    e.currentTarget.style.opacity = '1';
                });
            });
        }

        function addParetoDetailsEventListeners() {
             document.querySelectorAll('.rename-category-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const oldName = e.currentTarget.dataset.problemGroup;
                    domElements.oldCategoryNameInput.value = oldName;
                    domElements.renameCategoryNameInput.value = oldName;
                    domElements.renameCategoryModal.classList.remove('hidden');
                    domElements.renameCategoryNameInput.focus();
                });
            });

            document.querySelectorAll('.export-pareto-details-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const problemGroup = e.currentTarget.dataset.problemGroup;
                    exportParetoDetailsToExcel(problemGroup);
                });
            });

            const solutionButton = document.querySelector('#pareto-details-container .solution-guide-button');
            if (solutionButton) {
                solutionButton.addEventListener('click', async (event) => {
                    const problemGroup = event.currentTarget.dataset.problemGroup;
                    const machineData = lastResults.find(res => String(res.machineId) === String(currentParetoMachineId));
                    const groupData = currentParetoData.find(d => d.problemGroup === problemGroup);

                    if (machineData && groupData) {
                        if (!domElements.solutionDetailsColumnSelect.value) {
                            showMessage('Por favor, mapeie a "Coluna Detalhes da Solução" para gerar o guia.', 'warning');
                            return;
                        }
                        const orderIds = new Set(groupData.orderIds);
                        const ordersToAnalyze = machineData.orders.filter((order, index) => orderIds.has(index));
                        
                        await generateSolutionGuide(ordersToAnalyze, currentParetoMachineId, event.currentTarget);
                    }
                });
            }
        }
        
        function updateParetoData(draggedOrderId, destinationGroup) {
            const machineData = lastResults.find(res => String(res.machineId) === String(currentParetoMachineId));
            const orderToMove = machineData.orders[draggedOrderId];

            let sourceGroupData = null;
            let sourceGroupOrderIndex = -1;

            for (const group of currentParetoData) {
                const index = group.orderIds.indexOf(draggedOrderId);
                if (index > -1) {
                    sourceGroupData = group;
                    sourceGroupOrderIndex = index;
                    break;
                }
            }
            
            if (!sourceGroupData || sourceGroupData.problemGroup === destinationGroup) {
                return; 
            }

            sourceGroupData.frequency -= 1;
            sourceGroupData.totalHours -= orderToMove.downtime;
            sourceGroupData.orderIds.splice(sourceGroupOrderIndex, 1);
            
            currentParetoData = currentParetoData.filter(d => d.frequency > 0);

            let destinationGroupData = currentParetoData.find(d => d.problemGroup === destinationGroup);
            if (!destinationGroupData) {
                destinationGroupData = { problemGroup: destinationGroup, frequency: 0, totalHours: 0, orderIds: [] };
                currentParetoData.push(destinationGroupData);
            }
            destinationGroupData.frequency += 1;
            destinationGroupData.totalHours += orderToMove.downtime;
            destinationGroupData.orderIds.push(draggedOrderId);

            const currentSort = domElements.sortByHoursButton.classList.contains('bg-indigo-600') ? 'hours' : 'frequency';
            createParetoChart(currentParetoData, currentParetoMachineId, currentSort);
            domElements.paretoDetailsContainer.innerHTML = '<p class="text-center text-sm text-gray-500 dark:text-gray-400">Grupo atualizado. Clique em uma barra para ver os novos detalhes.</p>'; 
        }

        function renameParetoCategory(oldName, newName) {
            const group = currentParetoData.find(g => g.problemGroup === oldName);
            if (group) {
                group.problemGroup = newName;
            }
            const currentSort = domElements.sortByHoursButton.classList.contains('bg-indigo-600') ? 'hours' : 'frequency';
            createParetoChart(currentParetoData, currentParetoMachineId, currentSort);
            displayParetoDetails(newName);
        }

        function exportParetoDetailsToExcel(problemGroup) {
            const machineData = lastResults.find(res => String(res.machineId) === String(currentParetoMachineId));
            const groupData = currentParetoData.find(d => d.problemGroup === problemGroup);
            if (!machineData || !groupData) {
                showMessage('Dados não encontrados para exportação.', 'error');
                return;
            }

            const orderIds = new Set(groupData.orderIds);
            const relevantOrders = machineData.orders.filter((order, index) => orderIds.has(index));
            const formatDateTime = (date) => (!date || isNaN(date)) ? 'N/A' : date.toLocaleString('pt-BR', { timeZone: 'UTC' });

            const dataForSheet = relevantOrders.map(order => ({
                'OS': order.serviceOrder,
                'Título': order.title,
                'Data/Hora Abertura': formatDateTime(order.startDateTime),
                'Duração (h)': order.downtime
            }));

            const ws = XLSX.utils.json_to_sheet(dataForSheet);
            ws['!cols'] = [{ wch: 15 }, { wch: 50 }, { wch: 20 }, { wch: 15 }];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Detalhes Pareto');
            XLSX.writeFile(wb, `Detalhes_Pareto_${problemGroup.replace(/[^a-zA-Z0-9]/g, '_')}.xlsx`);
        }
        
        function generateKpiChart(kpiType, data, groupBy, rank = 'all', limit = null) {
            if (kpiChartInstance) {
                kpiChartInstance.destroy();
            }
            
            domElements.kpiFilterControls.dataset.groupBy = groupBy; 
            
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#E5E7EB' : '#1F2937';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            
            let chartTitle, goal, higherIsBetter;
            let sortedData = [...data];
            
            switch(kpiType) {
                case 'availability':
                    chartTitle = 'Gráfico Disponibilidade';
                    goal = parseFloat(domElements.availabilityGoalGreenInput.value);
                    higherIsBetter = true;
                    break;
                case 'mttr':
                    chartTitle = 'Gráfico MTTR';
                    goal = parseFloat(domElements.mttrGoalInput.value);
                    higherIsBetter = false;
                    break;
                case 'mtbf':
                    chartTitle = 'Gráfico MTBF';
                    goal = parseFloat(domElements.mtbfGoalInput.value);
                    higherIsBetter = true;
                    break;
            }
            
            if (rank === 'best') {
                if (higherIsBetter) sortedData.sort((a, b) => b[kpiType] - a[kpiType]);
                else sortedData.sort((a, b) => a[kpiType] - b[kpiType]);
            } else { 
                if (higherIsBetter) sortedData.sort((a, b) => a[kpiType] - b[kpiType]);
                else sortedData.sort((a, b) => b[kpiType] - a[kpiType]);
            }

            if (rank !== 'all' && limit) {
                sortedData = sortedData.slice(0, limit);
            }
            
            const labels = sortedData.map(res => res.label);
            const values = sortedData.map(res => parseFloat(res[kpiType].toFixed(2)));
            
            const backgroundColors = values.map(value => {
                if (higherIsBetter) {
                    return value >= goal ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)';
                } else {
                    return value <= goal ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)';
                }
            });
            
            const goalData = new Array(labels.length).fill(goal);
            const maxValue = Math.max(...values, goal);
            const yAxisMax = kpiType === 'availability' ? 100 : maxValue * 1.25;
            
            kpiChartInstance = new Chart(domElements.kpiChartCanvas.getContext('2d'), {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartTitle.split(' ')[1],
                        data: values,
                        backgroundColor: backgroundColors
                    }, {
                        label: `Meta (${goal.toFixed(2)})`,
                        data: goalData,
                        type: 'line',
                        borderColor: '#facc15', // Yellow
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0,
                        datalabels: { 
                            display: false
                        }
                    }]
                },
                options: {
                    responsive: true,
                    layout: {
                        padding: {
                            top: 30 
                        }
                    },
                    plugins: {
                        datalabels: {
                            display: true,
                            rotation: -90,
                            align: 'end',
                            anchor: 'end',
                            color: textColor,
                            font: { size: 10, weight: 'bold' },
                            formatter: (value) => kpiType === 'availability' ? value.toFixed(1) + '%' : value.toFixed(1)
                        },
                        legend: { 
                            position: 'bottom',
                            labels: {
                                color: textColor
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: textColor },
                            grid: { color: gridColor },
                            title: { display: true, text: kpiType === 'availability' ? 'Percentual (%)' : 'Horas', color: textColor },
                            max: yAxisMax
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        }
                    }
                }
            });
            
            domElements.kpiChartModalTitle.textContent = chartTitle;
            domElements.kpiChartModal.classList.remove('hidden');
        }
        
        function handleCostCenterChartGeneration(kpiType, rank = 'all', limit = null) {
            const config = {
                totalHours: parseFloat(domElements.totalHoursInput.value),
            };
            
            const ccAggregation = {};

            lastResults.forEach(res => {
                const cc = res.costCenter;
                if (!ccAggregation[cc]) {
                    ccAggregation[cc] = { totalDowntime: 0, totalEvents: 0, machineCount: 0, totalUptime: 0 };
                }
                ccAggregation[cc].totalDowntime += res.totalDowntime;
                ccAggregation[cc].totalEvents += res.totalEvents;
                ccAggregation[cc].machineCount += 1;
                ccAggregation[cc].totalUptime += (config.totalHours - res.totalDowntime);
            });

            const ccResults = Object.keys(ccAggregation).map(ccName => {
                const ccData = ccAggregation[ccName];
                const totalPeriodHoursForCC = config.totalHours * ccData.machineCount;

                const availability = totalPeriodHoursForCC > 0 ? (ccData.totalUptime / totalPeriodHoursForCC) * 100 : 0;
                const mttr = ccData.totalEvents > 0 ? (ccData.totalDowntime / ccData.totalEvents) : 0;
                const mtbf = ccData.totalEvents > 0 ? (ccData.totalUptime / ccData.totalEvents) : ccData.totalUptime;

                return { label: ccName, availability, mttr, mtbf };
            });

            generateKpiChart(kpiType, ccResults, 'costCenter', rank, limit);
        }

        async function generateSolutionGuide(orders, machineId, buttonElement) {
            if (!domElements.solutionDetailsColumnSelect.value) {
                showMessage('Por favor, mapeie a "Coluna Detalhes da Solução" para gerar o guia.', 'warning');
                return;
            }

            buttonElement.disabled = true;
            buttonElement.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-700 dark:text-gray-300 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

            const problemSolutionPairs = orders.map(o => ({ problem: o.title, solution: o.solution }));
            const prompt = `Como um engenheiro de manutenção sênior, analise a lista de problemas (problem) e as soluções aplicadas (solution) para o ativo ${machineId}. 
            1. Identifique os 3 problemas mais críticos (baseado em frequência e/ou similaridade).
            2. Para cada problema crítico, sintetize as soluções aplicadas e crie um guia de solução de problemas "passo a passo" claro e conciso em formato HTML.
            3. Use tags <h4> para o título de cada problema e listas ordenadas <ol> com <li> para os passos da solução. Formate o texto com negrito (<b>) para destacar peças ou ações importantes.

            Dados: ${JSON.stringify(problemSolutionPairs)}
            `;

            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
            const apiKey = "AIzaSyDwTbJWhdnP2Fyz2yjEo7D_3sDnieknz1w"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const result = await fetchWithBackoff(apiUrl, payload);
                
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                    const guideHtml = result.candidates[0].content.parts[0].text;
                    displaySolutionGuide(guideHtml, machineId);
                } else {
                    throw new Error("Resposta da API inválida ou vazia.");
                }
            } catch (error) {
                console.error("Erro ao gerar guia de soluções:", error);
                showMessage(`Erro na análise com IA: ${error.message}`, 'error');
            } finally {
                buttonElement.disabled = false;
                buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>`;
            }
        }

        function displaySolutionGuide(htmlContent, machineId) {
            domElements.solutionGuideTitle.textContent = `Guia de Soluções para Ativo: ${machineId}`;
            domElements.solutionGuideContent.innerHTML = htmlContent;
            domElements.solutionGuideModal.classList.remove('hidden');
        }

        function switchPage(pageId) {
            document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');

            document.querySelectorAll('nav a').forEach(link => {
                link.classList.remove('nav-active');
            });

            const activeLink = document.querySelector(`#nav-${pageId.replace('-page', '')}`);
            if (activeLink) {
                activeLink.classList.add('nav-active');
            }
            
            if (pageId === 'dashboard-page') {
                if (lastResults.length > 0) {
                    domElements.kpiTrendSection.classList.remove('hidden');
                    domElements.dashboardParetoMachineSection.classList.remove('hidden');
                    domElements.dashboardParetoDailySection.classList.remove('hidden');
                    domElements.dashboardNoData.classList.add('hidden');
                    generateKpiTrendChart();
                    generateDashboardPareto();
                    generateDailyParetoChart();
                } else {
                    domElements.kpiTrendSection.classList.add('hidden');
                    domElements.dashboardParetoMachineSection.classList.add('hidden');
                    domElements.dashboardParetoDailySection.classList.add('hidden');
                    domElements.dashboardNoData.classList.remove('hidden');
                }
            }
        }

        async function generateContextualPrompt(question) {
            if (!lastResults || lastResults.length === 0) {
                return {
                    prompt: `O usuário perguntou: "${question}". Não há dados de manutenção carregados. Por favor, instrua o usuário a carregar uma planilha na aba 'Analisador' e executar a análise primeiro.`,
                    hasData: false
                };
            }

            let foundMachineId = null;
            for (const res of lastResults) {
                if (question.toLowerCase().includes(String(res.machineId).toLowerCase())) {
                    foundMachineId = res.machineId;
                    break;
                }
            }

            let contextData;
            let basePrompt = "Você é um especialista em manutenção sênior e um chatbot de análise de dados. Responda à pergunta do usuário de forma concisa e focada, utilizando apenas os dados fornecidos. Se a informação não estiver nos dados, diga que não pode responder com os dados atuais.";

            if (foundMachineId) {
                const machineData = lastResults.find(res => String(res.machineId) === String(foundMachineId));
                if (machineData) {
                    const recentOrders = machineData.orders.slice(0, 5).map(order => ({
                        serviceOrder: order.serviceOrder,
                        title: order.title,
                        downtime: order.downtime.toFixed(2),
                        startDateTime: order.startDateTime.toLocaleString('pt-BR', { timeZone: 'UTC', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
                    }));
                    contextData = {
                        machineId: machineData.machineId,
                        description: machineData.description,
                        costCenter: machineData.costCenter,
                        totalDowntime: machineData.totalDowntime.toFixed(2),
                        totalEvents: machineData.totalEvents,
                        availability: machineData.availability.toFixed(2),
                        mtbf: machineData.mtbf.toFixed(2),
                        mttr: machineData.mttr.toFixed(2),
                        recentOrders: recentOrders
                    };
                    basePrompt += `\n\nContexto (dados do ativo ${foundMachineId}): ${JSON.stringify(contextData)}.`;
                } else {
                    contextData = null;
                    basePrompt += `\n\nNão encontrei dados para o ativo "${foundMachineId}" no período atual ou nos dados processados.`;
                }
            } else {
                const overallKpis = {
                    totalMachinesAnalyzed: lastResults.length,
                    overallAvailability: (lastResults.reduce((sum, res) => sum + res.availability, 0) / lastResults.length).toFixed(2),
                    overallMtbf: (lastResults.reduce((sum, res) => sum + res.mtbf, 0) / lastResults.length).toFixed(2),
                    overallMttr: (lastResults.reduce((sum, res) => sum + res.mttr, 0) / lastResults.length).toFixed(2),
                    top5DowntimeMachines: lastResults.sort((a,b) => b.totalDowntime - a.totalDowntime).slice(0,5).map(m => `${m.machineId} (${m.totalDowntime.toFixed(2)}h)`).join(', ')
                };
                basePrompt += `\n\nContexto (dados gerais da análise): ${JSON.stringify(overallKpis)}.`;
            }

            return {
                prompt: `${basePrompt}\n\nPergunta do usuário: "${question}"`,
                hasData: true
            };
        }

        async function getChatbotResponse(question) {
            const { prompt: contextualPrompt, hasData } = await generateContextualPrompt(question);

            if (!hasData) {
                return contextualPrompt;
            }

            const apiKey = "AIzaSyDwTbJWhdnP2Fyz2yjEo7D_3sDnieknz1w";
            const payload = { contents: [{ role: "user", parts: [{ text: contextualPrompt }] }] };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const result = await fetchWithBackoff(apiUrl, payload);
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    return "Desculpe, não consegui gerar uma resposta com os dados fornecidos.";
                }
            } catch (error) {
                console.error("Erro na API do Chatbot:", error);
                return `Desculpe, ocorreu um erro ao processar sua pergunta: ${error.message}.`;
            }
        }

        async function handleChatSubmit() {
            const userInput = domElements.chatInput.value.trim();
            if (!userInput) return;

            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'p-3 rounded-lg user-message chat-message';
            userMessageDiv.textContent = userInput;
            domElements.chatContainer.appendChild(userMessageDiv);

            domElements.chatInput.value = '';
            domElements.chatSendBtn.disabled = true;
            domElements.chatInput.placeholder = 'Aguarde a resposta...';

            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'p-3 rounded-lg bot-message chat-message text-gray-500 dark:text-gray-400 flex items-center';
            thinkingDiv.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-700 dark:text-gray-300 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Pensando...`;
            domElements.chatContainer.appendChild(thinkingDiv);
            domElements.chatContainer.scrollTop = domElements.chatContainer.scrollHeight;

            const botResponse = await getChatbotResponse(userInput);
            
            domElements.chatContainer.removeChild(thinkingDiv);
            const botMessageDiv = document.createElement('div');
            botMessageDiv.className = 'p-3 rounded-lg bot-message chat-message';
            botMessageDiv.textContent = botResponse;
            domElements.chatContainer.appendChild(botMessageDiv);

            domElements.chatContainer.scrollTop = domElements.chatContainer.scrollHeight;
            domElements.chatSendBtn.disabled = false;
            domElements.chatInput.placeholder = 'Pergunte sobre uma máquina ou problema...';
        }
        
        function generateDashboardPareto() {
            if (dashboardParetoInstance) {
                dashboardParetoInstance.destroy();
            }
            if (!lastResults || lastResults.length === 0) {
                return;
            }
            
            const machineCount = parseInt(domElements.dashboardParetoSlider.value);
            const sortedData = [...lastResults].sort((a, b) => b.totalDowntime - a.totalDowntime).slice(0, machineCount);
            const labels = sortedData.map(item => item.machineId);
            const downtimeData = sortedData.map(item => item.totalDowntime);

            const totalDowntimeSum = downtimeData.reduce((sum, item) => sum + item, 0);
            let cumulativePercentage = 0;
            const paretoLineData = downtimeData.map(downtime => {
                cumulativePercentage += (downtime / totalDowntimeSum) * 100;
                return cumulativePercentage;
            });

            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#E5E7EB' : '#1F2937';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            dashboardParetoInstance = new Chart(domElements.dashboardParetoCanvas.getContext('2d'), {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Horas Paradas',
                        data: downtimeData,
                        backgroundColor: 'rgba(79, 70, 229, 0.8)',
                        yAxisID: 'y',
                    }, {
                        label: 'Percentual Acumulado',
                        data: paretoLineData,
                        type: 'line',
                        borderColor: 'rgba(234, 179, 8, 1)',
                        backgroundColor: 'rgba(234, 179, 8, 0.2)',
                        fill: false,
                        yAxisID: 'y1',
                        tension: 0.1,
                        datalabels: {
                            display: false
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        datalabels: {
                            display: true,
                            align: 'end',
                            anchor: 'end',
                            color: textColor,
                            font: {
                                size: 10,
                                weight: 'bold',
                            },
                            formatter: (value) => parseFloat(value).toFixed(1),
                            rotation: -90,
                        },
                        title: {
                            display: true,
                            text: 'Pareto de Horas Paradas por Máquina',
                            color: textColor,
                            font: { size: 16 }
                        },
                        legend: { labels: { color: textColor } },
                    },
                    scales: {
                        x: { ticks: { color: textColor }, grid: { color: gridColor } },
                        y: {
                            beginAtZero: true,
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Total de Horas Paradas', color: textColor },
                            ticks: { color: textColor },
                            grid: { color: gridColor },
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 0,
                            max: 100,
                            title: { display: true, text: 'Percentual Acumulado (%)', color: textColor },
                            ticks: { color: textColor, callback: value => value.toFixed(0) + '%' },
                            grid: { drawOnChartArea: false },
                        }
                    }
                }
            });
        }

        function generateDailyParetoChart() {
            if (dailyParetoInstance) {
                dailyParetoInstance.destroy();
            }
            if (!lastResults || lastResults.length === 0) {
                return;
            }

            const dailyData = {};
            
            lastResults.forEach(machine => {
                machine.orders.forEach(order => {
                    const dateStr = toYYYYMMDD(order.startDateTime);
                    if (!dailyData[dateStr]) {
                        dailyData[dateStr] = { totalDowntime: 0, orderCount: 0 };
                    }
                    dailyData[dateStr].totalDowntime += order.downtime;
                    dailyData[dateStr].orderCount += 1;
                });
            });

            const sortedDates = Object.keys(dailyData).sort();
            const weekdays = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
            
            const totalDowntime = sortedDates.reduce((sum, date) => sum + dailyData[date].totalDowntime, 0);
            const totalOrders = sortedDates.reduce((sum, date) => sum + dailyData[date].orderCount, 0);
            const numberOfDays = sortedDates.length;
            const averageDowntime = numberOfDays > 0 ? totalDowntime / numberOfDays : 0;
            const averageOrders = numberOfDays > 0 ? totalOrders / numberOfDays : 0;

            const labels = [
                ["Soma", "Horas"],
                ["Média", "Horas"],
                ["Soma", "Ordens"],
                ["Média", "Ordens"],
                ...sortedDates.map(dateStr => {
                    const date = new Date(dateStr + 'T00:00:00Z');
                    const dayOfMonth = date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', timeZone: 'UTC' });
                    const dayOfWeek = weekdays[date.getUTCDay()];
                    return [dayOfMonth, dayOfWeek];
                })
            ];

            const downtimeData = [
                0, // Placeholder for Soma Horas
                averageDowntime,
                0,
                0,
                ...sortedDates.map(date => dailyData[date].totalDowntime)
            ];
            const orderCountData = [
                0,
                0,
                0, // Placeholder for Soma Ordens
                averageOrders,
                ...sortedDates.map(date => dailyData[date].orderCount)
            ];
            const totalDowntimeData = [totalDowntime, 0, 0, 0, ...Array(sortedDates.length).fill(0)];
            const totalOrdersData = [0, 0, totalOrders, 0, ...Array(sortedDates.length).fill(0)];
            
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#E5E7EB' : '#1F2937';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            dailyParetoInstance = new Chart(domElements.dashboardDailyParetoCanvas.getContext('2d'), {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Horas Paradas (Diário/Média)',
                        data: downtimeData,
                        backgroundColor: 'rgba(219, 39, 119, 0.8)', // Pink
                        yAxisID: 'y',
                    }, {
                        label: 'Quantidade de Ordens (Diário/Média)',
                        data: orderCountData,
                        backgroundColor: 'rgba(14, 165, 233, 0.8)', // Sky blue
                        yAxisID: 'y',
                    }, {
                        label: 'Soma Horas Paradas',
                        data: totalDowntimeData,
                        backgroundColor: 'rgba(236, 72, 153, 0.8)',
                        yAxisID: 'y_total',
                    }, {
                        label: 'Soma Ordens',
                        data: totalOrdersData,
                        backgroundColor: 'rgba(56, 189, 248, 0.8)',
                        yAxisID: 'y_total',
                    }]
                },
                options: {
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            if (index >= 4) { // Only trigger for daily bars
                                const dateStr = sortedDates[index - 4];
                                displayDailyDetails(dateStr);
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        datalabels: {
                            display: true,
                            color: textColor,
                            font: { size: 12, weight: 'bold' },
                            formatter: (value) => value > 0 ? parseFloat(value).toFixed(1) : null,
                             rotation: -90,
                             align: 'end',
                             anchor: 'end'
                        },
                        title: {
                            display: true,
                            text: 'Pareto Diário de Paradas e Ordens',
                            color: textColor,
                            font: { size: 16 }
                        },
                        legend: { labels: { color: textColor } },
                    },
                    scales: {
                        x: { ticks: { color: textColor }, grid: { color: gridColor } },
                        y: {
                            beginAtZero: true,
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Valores Diários e Médios', color: textColor },
                            ticks: { color: textColor },
                            grid: { color: gridColor },
                        },
                        y_total: {
                            beginAtZero: true,
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Valores Totais', color: textColor },
                            ticks: { color: textColor },
                            grid: { drawOnChartArea: false },
                        }
                    }
                }
            });
        }

        function displayDailyDetails(dateStr) {
            const date = new Date(dateStr + 'T00:00:00Z');
            domElements.dailyDetailsModalTitle.textContent = `Detalhes para o dia: ${date.toLocaleDateString('pt-BR', {timeZone: 'UTC'})}`;
            
            const ordersForDay = [];
            lastResults.forEach(machine => {
                machine.orders.forEach(order => {
                    if (toYYYYMMDD(order.startDateTime) === dateStr) {
                        ordersForDay.push({
                            machineId: machine.machineId,
                            description: machine.description,
                            costCenter: machine.costCenter,
                            ...order
                        });
                    }
                });
            });

            currentDailyDetailsData = { date: dateStr, orders: ordersForDay };

            const formatDateTime = (d) => d.toLocaleString('pt-BR', { timeZone: 'UTC', day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

            let tableHTML = `<table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Máquina</th>
                        <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Descrição</th>
                        <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Linha</th>
                        <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-300">OS</th>
                        <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Título OS</th>
                        <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Data/Hora</th>
                        <th class="px-2 py-2 text-left font-medium text-gray-500 dark:text-gray-300">Duração (h)</th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    ${ordersForDay.map(order => `
                        <tr>
                            <td class="px-2 py-2 whitespace-nowrap">${order.machineId}</td>
                            <td class="px-2 py-2 whitespace-nowrap">${order.description}</td>
                            <td class="px-2 py-2 whitespace-nowrap">${order.costCenter}</td>
                            <td class="px-2 py-2 whitespace-nowrap">${order.serviceOrder}</td>
                            <td class="px-2 py-2 whitespace-nowrap">${order.title}</td>
                            <td class="px-2 py-2 whitespace-nowrap">${formatDateTime(order.startDateTime)}</td>
                            <td class="px-2 py-2 whitespace-nowrap">${order.downtime.toFixed(2)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;

            domElements.dailyDetailsTableContainer.innerHTML = tableHTML;
            domElements.dailyDetailsModal.classList.remove('hidden');
        }


        function printChart(chartInstance) {
            if (!chartInstance) return;

            const canvas = chartInstance.canvas;
            const ctx = canvas.getContext('2d');

            // Store original colors
            const originalColors = {
                xTicks: chartInstance.options.scales.x.ticks.color,
                yTicks: chartInstance.options.scales.y.ticks.color,
                y1Ticks: chartInstance.options.scales.y1 ? chartInstance.options.scales.y1.ticks.color : undefined,
                legend: chartInstance.options.plugins.legend.labels.color,
                title: chartInstance.options.plugins.title.color,
                yTitle: chartInstance.options.scales.y.title.color,
                y1Title: chartInstance.options.scales.y1 ? chartInstance.options.scales.y1.title.color : undefined,
                datalabels: chartInstance.options.plugins.datalabels.color
            };

            // Set colors for printing
            const printColor = '#000000';
            chartInstance.options.scales.x.ticks.color = printColor;
            chartInstance.options.scales.y.ticks.color = printColor;
            if (chartInstance.options.scales.y1) chartInstance.options.scales.y1.ticks.color = printColor;
            chartInstance.options.plugins.legend.labels.color = printColor;
            chartInstance.options.plugins.title.color = printColor;
            chartInstance.options.scales.y.title.color = printColor;
            if (chartInstance.options.scales.y1) chartInstance.options.scales.y1.title.color = printColor;
            chartInstance.options.plugins.datalabels.color = printColor;
            
            chartInstance.update();

            // Draw to a new canvas with a white background
            ctx.save();
            ctx.globalCompositeOperation = 'destination-over';
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const url = canvas.toDataURL('image/png');
            ctx.restore();

            // Restore original colors
            chartInstance.options.scales.x.ticks.color = originalColors.xTicks;
            chartInstance.options.scales.y.ticks.color = originalColors.yTicks;
            if (chartInstance.options.scales.y1) chartInstance.options.scales.y1.ticks.color = originalColors.y1Ticks;
            chartInstance.options.plugins.legend.labels.color = originalColors.legend;
            chartInstance.options.plugins.title.color = originalColors.title;
            chartInstance.options.scales.y.title.color = originalColors.yTitle;
            if (chartInstance.options.scales.y1) chartInstance.options.scales.y1.title.color = originalColors.y1Title;
            chartInstance.options.plugins.datalabels.color = originalColors.datalabels;
            chartInstance.update();

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head><title>Imprimir Gráfico</title></head>
                    <body style="text-align: center; margin-top: 20px;">
                        <img src="${url}" style="max-width: 100%;">
                        <script>
                            window.onload = () => {
                                window.print();
                                window.close();
                            };
                        <\/script>
                    </body>
                </html>
            `);
        }

        function generateKpiTrendChart() {
            if (kpiTrendChartInstance) {
                kpiTrendChartInstance.destroy();
            }
            if (!lastResults || lastResults.length === 0) {
                return;
            }

            const { kpi, period } = currentKpiTrendView;
            const allOrders = lastResults.flatMap(res => res.orders);

            const aggregatedByPeriod = {};

            const reportStartDate = new Date(domElements.reportStartDateInput.value + 'T00:00:00Z');
            const reportEndDate = new Date(domElements.reportEndDateInput.value + 'T23:59:59Z');
            let currentDate = new Date(reportStartDate);

            if (period === 'monthly') {
                while (currentDate <= reportEndDate) {
                    const monthKey = `${currentDate.getUTCFullYear()}-${String(currentDate.getUTCMonth() + 1).padStart(2, '0')}`;
                    if (!aggregatedByPeriod[monthKey]) {
                        aggregatedByPeriod[monthKey] = { totalDowntime: 0, totalEvents: 0 };
                    }
                    currentDate.setUTCMonth(currentDate.getUTCMonth() + 1);
                }
            } else { // weekly
                 while (currentDate <= reportEndDate) {
                    const weekStart = new Date(currentDate);
                    weekStart.setUTCDate(currentDate.getUTCDate() - currentDate.getUTCDay());
                    const weekKey = toYYYYMMDD(weekStart);
                     if (!aggregatedByPeriod[weekKey]) {
                        aggregatedByPeriod[weekKey] = { totalDowntime: 0, totalEvents: 0 };
                    }
                    currentDate.setUTCDate(currentDate.getUTCDate() + 7);
                }
            }
            
            allOrders.forEach(order => {
                let periodKey;
                if (period === 'monthly') {
                    periodKey = `${order.startDateTime.getUTCFullYear()}-${String(order.startDateTime.getUTCMonth() + 1).padStart(2, '0')}`;
                } else { // weekly
                    const date = order.startDateTime;
                    const weekStart = new Date(date);
                    weekStart.setUTCDate(date.getUTCDate() - date.getUTCDay());
                    periodKey = toYYYYMMDD(weekStart);
                }
                
                if (aggregatedByPeriod[periodKey]) {
                    aggregatedByPeriod[periodKey].totalDowntime += order.downtime;
                    aggregatedByPeriod[periodKey].totalEvents += 1;
                }
            });
            
            const sortedKeys = Object.keys(aggregatedByPeriod).sort();
            
            const labels = sortedKeys.map(key => {
                if (period === 'monthly') {
                    const [year, month] = key.split('-');
                    return new Date(year, month - 1, 1).toLocaleDateString('pt-BR', { month: 'short', year: '2-digit', timeZone: 'UTC' });
                } else { // weekly
                    const startDate = new Date(key + 'T00:00:00Z');
                    return `Sem ${startDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', timeZone: 'UTC' })}`;
                }
            });

            const machineCount = lastResults.length;

            const data = sortedKeys.map(key => {
                const periodData = aggregatedByPeriod[key];
                
                let hoursInPeriod;
                if (period === 'monthly') {
                    const [year, month] = key.split('-').map(Number);
                    const daysInMonth = new Date(year, month, 0).getDate();
                    hoursInPeriod = daysInMonth * 24;
                } else { // weekly
                    hoursInPeriod = 7 * 24;
                }

                const totalPeriodHours = hoursInPeriod * machineCount;
                const totalUptime = Math.max(0, totalPeriodHours - periodData.totalDowntime);

                switch (kpi) {
                    case 'availability':
                        return totalPeriodHours > 0 ? (totalUptime / totalPeriodHours) * 100 : 0;
                    case 'mttr':
                        return periodData.totalEvents > 0 ? periodData.totalDowntime / periodData.totalEvents : 0;
                    case 'mtbf':
                        return periodData.totalEvents > 0 ? totalUptime / periodData.totalEvents : totalUptime;
                    default:
                        return 0;
                }
            });

            const kpiInfo = {
                availability: { label: 'Disponibilidade (%)', color: 'rgba(79, 70, 229, 1)', goal: parseFloat(domElements.kpiTrendAvailabilityGoal.value) },
                mttr: { label: 'MTTR (h)', color: 'rgba(219, 39, 119, 1)', goal: parseFloat(domElements.kpiTrendMttrGoal.value) },
                mtbf: { label: 'MTBF (h)', color: 'rgba(22, 163, 74, 1)', goal: parseFloat(domElements.kpiTrendMtbfGoal.value) }
            };

            const datasets = [{
                label: kpiInfo[kpi].label,
                data: data.map(d => d.toFixed(2)),
                borderColor: kpiInfo[kpi].color,
                backgroundColor: kpiInfo[kpi].color.replace('1)', '0.2)'),
                fill: true,
                tension: 0.1
            }];

            if (!isNaN(kpiInfo[kpi].goal)) {
                datasets.push({
                    label: `Meta (${kpiInfo[kpi].goal.toFixed(2)})`,
                    data: new Array(labels.length).fill(kpiInfo[kpi].goal),
                    type: 'line',
                    borderColor: '#ef4444', // Red
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0,
                    datalabels: {
                        display: false
                    }
                });
            }
            
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#E5E7EB' : '#1F2937';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            kpiTrendChartInstance = new Chart(domElements.kpiTrendCanvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                             labels: {
                                color: textColor
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y;
                                        if (kpi === 'availability') {
                                            label += '%';
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: textColor }, grid: { color: gridColor } },
                        y: {
                            beginAtZero: kpi !== 'availability',
                            ticks: { color: textColor },
                            grid: { color: gridColor },
                            title: {
                                display: true,
                                text: kpiInfo[kpi].label,
                                color: textColor
                            }
                        }
                    }
                }
            });
        }

        function initializeEventListeners() {
            domElements.themeToggleBtn.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                applyTheme();
            });

            domElements.navDashboard.addEventListener('click', (e) => {
                e.preventDefault();
                switchPage('dashboard-page');
            });

            domElements.navAnalyzer.addEventListener('click', (e) => {
                e.preventDefault();
                switchPage('analyzer-page');
            });

            domElements.navChatbot.addEventListener('click', (e) => {
                e.preventDefault();
                switchPage('chatbot-page');
            });

            domElements.chatSendBtn.addEventListener('click', handleChatSubmit);
            domElements.chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleChatSubmit();
                }
            });

            domElements.paretoModalClose.addEventListener('click', () => {
                domElements.paretoModal.classList.add('hidden');
                domElements.paretoDetailsContainer.innerHTML = '';
                currentParetoData = null; 
            });
            
            domElements.sortByHoursButton.addEventListener('click', () => {
                if(currentParetoData) createParetoChart(currentParetoData, currentParetoMachineId, 'hours');
                domElements.sortByHoursButton.classList.replace('bg-gray-200', 'bg-indigo-600');
                domElements.sortByHoursButton.classList.add('text-white');
                domElements.sortByFrequencyButton.classList.replace('bg-indigo-600', 'bg-gray-200');
                domElements.sortByFrequencyButton.classList.remove('text-white');
            });

            domElements.sortByFrequencyButton.addEventListener('click', () => {
                if(currentParetoData) createParetoChart(currentParetoData, currentParetoMachineId, 'frequency');
                domElements.sortByFrequencyButton.classList.replace('bg-gray-200', 'bg-indigo-600');
                domElements.sortByFrequencyButton.classList.add('text-white');
                domElements.sortByHoursButton.classList.replace('bg-indigo-600', 'bg-gray-200');
                domElements.sortByHoursButton.classList.remove('text-white');
            });

            domElements.printChartButton.addEventListener('click', () => printChart(paretoChartInstance));
            
            document.querySelectorAll('.kpi-chart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const kpiType = e.currentTarget.dataset.kpi;
                    const groupBy = e.currentTarget.dataset.groupBy;
                    currentKpiChartType = kpiType; 
                    
                    document.querySelectorAll('#kpi-filter-controls button').forEach(btn => {
                        btn.classList.remove('bg-indigo-600', 'text-white');
                        btn.classList.add('bg-gray-200', 'dark:bg-gray-600', 'text-gray-800', 'dark:text-gray-200');
                        if (btn.dataset.rank === 'all') {
                            btn.classList.add('bg-indigo-600', 'text-white');
                            btn.classList.remove('bg-gray-200', 'dark:bg-gray-600', 'text-gray-800', 'dark:text-gray-200');
                        }
                    });

                    if (groupBy === 'costCenter') {
                        handleCostCenterChartGeneration(kpiType);
                    } else {
                        const assetData = lastResults.map(res => ({ ...res, label: res.machineId }));
                        generateKpiChart(kpiType, assetData, 'asset');
                    }
                });
            });
            
            domElements.kpiFilterControls.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const rank = e.target.dataset.rank;
                    const limit = e.target.dataset.limit ? parseInt(e.target.dataset.limit) : null;
                    const groupBy = document.querySelector('#kpi-filter-controls').dataset.groupBy;
                    
                    document.querySelectorAll('#kpi-filter-controls button').forEach(btn => {
                        btn.classList.remove('bg-indigo-600', 'text-white');
                        btn.classList.add('bg-gray-200', 'dark:bg-gray-600', 'text-gray-800', 'dark:text-gray-200');
                    });
                    
                    e.target.classList.add('bg-indigo-600', 'text-white');
                    e.target.classList.remove('bg-gray-200', 'dark:bg-gray-600', 'text-gray-800', 'dark:text-gray-200');
                    
                    if(groupBy === 'costCenter') {
                        handleCostCenterChartGeneration(currentKpiChartType, rank, limit);
                    } else {
                        const assetData = lastResults.map(res => ({ ...res, label: res.machineId }));
                        generateKpiChart(currentKpiChartType, assetData, 'asset', rank, limit);
                    }
                }
            });

            domElements.kpiModalClose.addEventListener('click', () => {
                domElements.kpiChartModal.classList.add('hidden');
            });
            
            domElements.solutionGuideClose.addEventListener('click', () => {
                domElements.solutionGuideModal.classList.add('hidden');
            });

            domElements.printSolutionGuideButton.addEventListener('click', () => {
                const content = domElements.solutionGuideContent.innerHTML;
                const title = domElements.solutionGuideTitle.textContent;
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head><title>${title}</title>
                        <style>
                            body { font-family: 'Inter', sans-serif; margin: 20px; }
                            h4 { font-size: 1.25em; margin-bottom: 0.5em; border-bottom: 1px solid #ccc; padding-bottom: 5px;}
                            ol { padding-left: 20px; }
                            li { margin-bottom: 1em; }
                            b { font-weight: 600; }
                        </style>
                        </head>
                        <body>
                            <h1>${title}</h1>
                            ${content}
                            <script>
                                window.onload = () => {
                                    window.print();
                                    window.close();
                                };
                            <\/script>
                        </body>
                    </html>
                `);
            });
            
            domElements.menuToggleBtn.addEventListener('click', () => {
                domElements.sidebar.classList.toggle('-translate-x-full');
                domElements.sidebarOverlay.classList.toggle('hidden');
            });

            domElements.sidebarOverlay.addEventListener('click', () => {
                domElements.sidebar.classList.add('-translate-x-full');
                domElements.sidebarOverlay.classList.add('hidden');
            });

            domElements.fileUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                domElements.fileNameDisplay.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        hideMessage();
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false, dateNF: 'dd/mm/yyyy' });
                        if (jsonData.length === 0) throw new Error("A planilha parece estar vazia.");
                        const headers = Object.keys(jsonData[0]);
                        populateSelectors(headers);
                        updateReportDateRange();
                        populateProductionLineFilter();
                        domElements.analysisSection.classList.remove('hidden');
                        domElements.analyzerNoData.classList.add('hidden');
                        domElements.resultsSection.classList.add('hidden');
                        switchPage('analyzer-page');
                    } catch (err) {
                        showMessage(err.message || "Não foi possível ler o arquivo.");
                        domElements.analysisSection.classList.add('hidden');
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            domElements.analyzeButton.addEventListener('click', runAnalysis);

            domElements.newCategoryCreateButton.addEventListener('click', () => {
                const newName = domElements.newCategoryNameInput.value.trim();
                if (newName && draggedItemData && draggedItemData.orderId !== null) {
                    updateParetoData(draggedItemData.orderId, newName);
                    domElements.newCategoryModal.classList.add('hidden');
                    domElements.newCategoryNameInput.value = '';
                    draggedItemData = null; 
                }
            });
            
            domElements.newCategoryCancelButton.addEventListener('click', () => {
                domElements.newCategoryModal.classList.add('hidden');
                domElements.newCategoryNameInput.value = '';
                draggedItemData = null;
            });

            domElements.renameCategorySaveButton.addEventListener('click', () => {
                const oldName = domElements.oldCategoryNameInput.value;
                const newName = domElements.renameCategoryNameInput.value.trim();
                if (newName && oldName) {
                    renameParetoCategory(oldName, newName);
                    domElements.renameCategoryModal.classList.add('hidden');
                }
            });

            domElements.renameCategoryCancelButton.addEventListener('click', () => {
                domElements.renameCategoryModal.classList.add('hidden');
            });

            domElements.yearSelect.addEventListener('change', () => {
                domElements.monthSelect.value = ""; 
                domElements.weekSelect.value = ""; 
                populateMonthSelector(); 
                populateWeekSelector(); 
                handleDateFilterChange(); 
            });

            domElements.monthSelect.addEventListener('change', () => {
                domElements.weekSelect.value = ""; 
                populateWeekSelector(); 
                handleDateFilterChange(); 
            });

            domElements.weekSelect.addEventListener('change', handleDateFilterChange);

            domElements.clearFiltersButton.addEventListener('click', clearFilters);

            domElements.toggleReportFieldsButton.addEventListener('click', () => {
                const isHidden = domElements.reportFieldsContent.classList.contains('hidden');
                domElements.reportFieldsContent.classList.toggle('hidden');
                domElements.toggleReportFieldsButton.textContent = isHidden ? '−' : '+';
            });

            domElements.dashboardParetoSlider.addEventListener('input', (e) => {
                domElements.dashboardParetoSliderValue.textContent = e.target.value;
                generateDashboardPareto();
            });

            domElements.printMachineParetoButton.addEventListener('click', () => printChart(dashboardParetoInstance));
            domElements.printDailyParetoButton.addEventListener('click', () => printChart(dailyParetoInstance));

            domElements.dailyDetailsClose.addEventListener('click', () => {
                domElements.dailyDetailsModal.classList.add('hidden');
            });
            
            domElements.exportDailyDetailsButton.addEventListener('click', () => {
                if (currentDailyDetailsData) {
                    const { date, orders } = currentDailyDetailsData;
                    const formatDateTime = (d) => d.toLocaleString('pt-BR', { timeZone: 'UTC' });
                    const dataForSheet = orders.map(order => ({
                        'Máquina': order.machineId,
                        'Descrição': order.description,
                        'Linha': order.costCenter,
                        'OS': order.serviceOrder,
                        'Título OS': order.title,
                        'Data/Hora Abertura': formatDateTime(order.startDateTime),
                        'Duração (h)': order.downtime
                    }));
                    const ws = XLSX.utils.json_to_sheet(dataForSheet);
                    ws['!cols'] = [{ wch: 15 }, { wch: 30 }, { wch: 20 }, { wch: 15 }, { wch: 50 }, { wch: 20 }, { wch: 15 }];
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, `Detalhes_${date}`);
                    XLSX.writeFile(wb, `Detalhes_Dia_${date}.xlsx`);
                }
            });

            domElements.printDailyDetailsButton.addEventListener('click', () => {
                if (currentDailyDetailsData) {
                    const title = domElements.dailyDetailsModalTitle.textContent;
                    const tableHTML = domElements.dailyDetailsTableContainer.innerHTML;
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html><head><title>${title}</title>
                        <style>
                            body { font-family: 'Inter', sans-serif; margin: 20px; }
                            h1 { text-align: center; font-size: 1.5em; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 10px; }
                            th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
                            th { background-color: #f2f2f2; font-weight: 600; }
                            tr:nth-child(even) { background-color: #f9f9f9; }
                        </style>
                        </head><body><h1>${title}</h1>${tableHTML}
                        <script>window.onload = () => { window.print(); window.close(); };<\/script>
                        </body></html>`);
                }
            });
            
            domElements.kpiTrendKpiControls.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    currentKpiTrendView.kpi = e.target.dataset.kpi;
                    document.querySelectorAll('.kpi-trend-kpi-btn').forEach(btn => btn.classList.remove('control-btn-active'));
                    e.target.classList.add('control-btn-active');
                    generateKpiTrendChart();
                }
            });

            domElements.kpiTrendPeriodControls.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    currentKpiTrendView.period = e.target.dataset.period;
                    document.querySelectorAll('.kpi-trend-period-btn').forEach(btn => btn.classList.remove('control-btn-active'));
                    e.target.classList.add('control-btn-active');
                    generateKpiTrendChart();
                }
            });
            
            document.querySelectorAll('.kpi-trend-goal-input').forEach(input => {
                input.addEventListener('change', generateKpiTrendChart);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            domElements = {
                fileUpload: document.getElementById('file-upload'),
                fileNameDisplay: document.getElementById('file-name'),
                analysisSection: document.getElementById('analysis-section'),
                analyzerNoData: document.getElementById('analyzer-no-data'),
                resultsSection: document.getElementById('results-section'),
                reportStartDateInput: document.getElementById('report-start-date'),
                reportEndDateInput: document.getElementById('report-end-date'),
                totalHoursInput: document.getElementById('total-hours'),
                machineColumnSelect: document.getElementById('machine-column'),
                assetNameColumnSelect: document.getElementById('asset-name-column'),
                downtimeColumnSelect: document.getElementById('downtime-column'),
                serviceOrderColumnSelect: document.getElementById('service-order-column'),
                orderTitleColumnSelect: document.getElementById('order-title-column'),
                startDateColumnSelect: document.getElementById('start-date-column'),
                startTimeColumnSelect: document.getElementById('start-time-column'),
                analyzeButton: document.getElementById('analyze-button'),
                resultsTableContainer: document.getElementById('results-table-container'),
                errorMessageDiv: document.getElementById('error-message'),
                availabilityGoalYellowInput: document.getElementById('availability-goal-yellow'),
                availabilityGoalGreenInput: document.getElementById('availability-goal-green'),
                mtbfGoalInput: document.getElementById('mtbf-goal'),
                mttrGoalInput: document.getElementById('mttr-goal'),
                yearSelect: document.getElementById('year-select'),
                monthSelect: document.getElementById('month-select'),
                weekSelect: document.getElementById('week-select'),
                clearFiltersButton: document.getElementById('clear-filters-button'),
                themeToggleBtn: document.getElementById('theme-toggle'),
                themeToggleDarkIcon: document.getElementById('theme-toggle-dark-icon'),
                themeToggleLightIcon: document.getElementById('theme-toggle-light-icon'),
                costCenterColumnSelect: document.getElementById('cost-center-column'),
                productionLineFilterSelect: document.getElementById('production-line-filter'),
                paretoModal: document.getElementById('pareto-modal'),
                paretoModalTitle: document.getElementById('pareto-modal-title'),
                paretoModalClose: document.getElementById('pareto-modal-close'),
                paretoChartContainer: document.getElementById('pareto-chart-container'),
                printChartButton: document.getElementById('print-chart-button'),
                sortByHoursButton: document.getElementById('sort-by-hours'),
                sortByFrequencyButton: document.getElementById('sort-by-frequency'),
                paretoDetailsContainer: document.getElementById('pareto-details-container'),
                newCategoryModal: document.getElementById('new-category-modal'),
                newCategoryNameInput: document.getElementById('new-category-name'),
                newCategoryCreateButton: document.getElementById('new-category-create'),
                newCategoryCancelButton: document.getElementById('new-category-cancel'),
                renameCategoryModal: document.getElementById('rename-category-modal'),
                renameCategoryNameInput: document.getElementById('rename-category-name'),
                oldCategoryNameInput: document.getElementById('old-category-name'),
                renameCategorySaveButton: document.getElementById('rename-category-save'),
                renameCategoryCancelButton: document.getElementById('rename-category-cancel'),
                newCategoryDropzone: document.getElementById('new-category-dropzone'),
                kpiChartModal: document.getElementById('kpi-chart-modal'),
                kpiChartModalTitle: document.getElementById('kpi-chart-modal-title'),
                kpiChartCanvas: document.getElementById('kpi-chart-canvas'),
                kpiModalClose: document.getElementById('kpi-modal-close'),
                kpiFilterControls: document.getElementById('kpi-filter-controls'),
                solutionDetailsColumnSelect: document.getElementById('solution-details-column'),
                solutionGuideModal: document.getElementById('solution-guide-modal'),
                solutionGuideTitle: document.getElementById('solution-guide-title'),
                solutionGuideContent: document.getElementById('solution-guide-content'),
                solutionGuideClose: document.getElementById('solution-guide-close'),
                printSolutionGuideButton: document.getElementById('print-solution-guide-button'),
                navDashboard: document.getElementById('nav-dashboard'),
                navAnalyzer: document.getElementById('nav-analyzer'),
                navChatbot: document.getElementById('nav-chatbot'),
                dashboardPage: document.getElementById('dashboard-page'),
                analyzerPage: document.getElementById('analyzer-page'),
                chatbotPage: document.getElementById('chatbot-page'),
                chatContainer: document.getElementById('chat-container'),
                chatInput: document.getElementById('chat-input'),
                chatSendBtn: document.getElementById('chat-send-btn'),
                menuToggleBtn: document.getElementById('menu-toggle-btn'),
                sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                toggleReportFieldsButton: document.getElementById('toggle-report-fields'),
                reportFieldsContent: document.getElementById('report-fields-content'),
                summaryAvailability: document.getElementById('summary-availability'),
                summaryMttr: document.getElementById('summary-mttr'),
                summaryMtbf: document.getElementById('summary-mtbf'),
                dashboardParetoMachineSection: document.getElementById('dashboard-pareto-machine-section'),
                dashboardParetoDailySection: document.getElementById('dashboard-pareto-daily-section'),
                dashboardParetoContainer: document.getElementById('dashboard-pareto-container'),
                dashboardParetoCanvas: document.getElementById('dashboard-pareto-canvas'),
                dashboardDailyParetoContainer: document.getElementById('dashboard-daily-pareto-container'),
                dashboardDailyParetoCanvas: document.getElementById('dashboard-daily-pareto-canvas'),
                dashboardNoData: document.getElementById('dashboard-no-data'),
                dashboardParetoSlider: document.getElementById('dashboard-pareto-slider'),
                dashboardParetoSliderValue: document.getElementById('dashboard-pareto-slider-value'),
                printMachineParetoButton: document.getElementById('print-machine-pareto-button'),
                printDailyParetoButton: document.getElementById('print-daily-pareto-button'),
                dailyDetailsModal: document.getElementById('daily-details-modal'),
                dailyDetailsModalTitle: document.getElementById('daily-details-modal-title'),
                dailyDetailsTableContainer: document.getElementById('daily-details-table-container'),
                dailyDetailsClose: document.getElementById('daily-details-close'),
                printDailyDetailsButton: document.getElementById('print-daily-details-button'),
                exportDailyDetailsButton: document.getElementById('export-daily-details-button'),
                kpiTrendSection: document.getElementById('kpi-trend-section'),
                kpiTrendCanvas: document.getElementById('kpi-trend-canvas'),
                kpiTrendKpiControls: document.getElementById('kpi-trend-kpi-controls'),
                kpiTrendPeriodControls: document.getElementById('kpi-trend-period-controls'),
                kpiTrendAvailabilityGoal: document.getElementById('kpi-trend-availability-goal'),
                kpiTrendMttrGoal: document.getElementById('kpi-trend-mttr-goal'),
                kpiTrendMtbfGoal: document.getElementById('kpi-trend-mtbf-goal'),
            };
            initializeEventListeners();
            applyTheme();
            switchPage('analyzer-page'); // Inicia na página do analisador
        });
    </script>
</body>
</html>
